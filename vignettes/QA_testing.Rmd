---
title: "QA_testing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QA_testing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cityHeatHealth)
```

```{r}


# *****
#slow way to update
# unloadNamespace("cityHeatHealth")
# remotes::install_github("cmilando/cityHeatHealth")

# once you update your R version you can just do
#load locally with devtools::load_all()
#if you want to actually make changes to the files.
# *****

library(data.table)

data <- readRDS("../data-raw/weekly_mort_updated_nov17.RDS")
setDT(data)

# just get a specific subset
data <- subset(data, region %in% 'Southeast')

# Select only the needed columns
data <- data[, .(
  X_week_end_date,
  X_deaths,
  mean_temp_C,
  occurrence_county_code,
  region
)]

# Order by county code and week end date
setorder(data, occurrence_county_code, X_week_end_date)
```


Exposure data

```{r exp}
exposure_columns <- list(
  "date" = "X_week_end_date",
  "exposure" = "mean_temp_C",
  "geo_unit" = "occurrence_county_code",
  "geo_unit_grp" = "region"
)

exp_data <- data[, .(
  X_week_end_date,
  mean_temp_C,
  occurrence_county_code,
  region
)]

exposure_matrix <- make_exposure_matrix(
  exp_data, exposure_columns, dt_by = 'week')

head(exposure_matrix)
```

Outcome
```{r outcome}
outcome_columns <- list(
  "date" = "X_week_end_date",
  "outcome" = "X_deaths",
  # "factor" = 'age_grp',
  # "factor" = 'sex',
  "geo_unit" = "occurrence_county_code",
  "geo_unit_grp" = "region"
)

out_data <- data[, .(
  X_week_end_date,
  X_deaths,
  occurrence_county_code,
  region
)]

outcomes_tbl <- make_outcome_table(out_data, outcome_columns)
outcomes_tbl
```


```{r runModel}
model <- condPois_1stage(exposure_matrix, outcomes_tbl, 
                         multi_zone = T)
```

```{r plot v1}
plot(model, title = 'Southeast')
```

```{r runModel2}
model2 <- condPois_2stage(exposure_matrix, outcomes_tbl,
                          verbose = 1)
```
```


