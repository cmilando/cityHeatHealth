---
title: "Heat-Health Associations across multiple towns using `cityHeatHealth`"
output:
  rmarkdown::html_vignette:
    fig.retina: 2
    dev: svg
vignette: >
  %\VignetteIndexEntry{Heat-Health Associations across multiple towns using `cityHeatHealth`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cityHeatHealth)
```

We can easily extend the functionality from `vignette("one_stage_demo")` to estimate individual-zone impacts across many zones.

### Model

First create the inputs, using the same `exposure_columns` and `outcome_columns` as before.
```{r multi_town_setup}
exposure_columns <- list(
  "date" = "date",
  "exposure" = "tmax_C",
  "geo_unit" = "TOWN20",
  "geo_unit_grp" = "COUNTY20"
)

ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)

outcome_columns <- list(
  "date" = "date",
  "outcome" = "daily_deaths",
  "factor" = 'age_grp',
  "factor" = 'sex',
  "geo_unit" = "TOWN20",
  "geo_unit_grp" = "COUNTY20"
)
ma_outcomes_tbl <- make_outcome_table(ma_deaths, outcome_columns)
```

Now run by using `condPois_2stage`. This does the Gasp Extended2stage design in 1 function from these inputs and defaults for `argvar`, `arglag` and `maxlag`. 

Importantly, the estimates in each `geo_unit` are bolstered by those in their `geo_unit_grp` by including a random effect for `geo_unit_grp` in the `mixmeta` model.

```{r multi_town_run}
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
```
You can still view the RR output from a single zone:
```{r multi_plot_sigle, fig.height=3, fig.width=5}
plot(ma_model, "BOSTON")
```
It does seem like this is a wider confidence interval than the solo model -- Perhaps this is expected given the variables around it? Worth investigating in your dataset, as these are simulated data.

You can also plot by `geo_unit_grp` (TODO -- a way to make this cleaner to get to)

```{r grp, fig.height=8, fig.width=8}
ma_model$`_`$grp_plt
```


You can also make a forest plot at a specific exposure value
```{r multi_plot_multiple, fig.height=5, fig.width=8}
forest_plot(ma_model, 25.1)
```

Finally you can also plot how the RR changes at specific expsoure units across space -- for this you need to bring in an `sf` shapefile:
```{r multi_plot_multiple, fig.height=5, fig.width=8}
data("ma_towns")
ma_towns
head(ma_towns)

spatial_plot(ma_model, ma_towns, exposure_val = 25.1)
```


### Model by factor

Only a small change is required to run the model by factor, e.g., age_grp:

```{r multi_town_setup_factor}
ma_outcomes_tbl_fct <- make_outcome_table(ma_deaths, 
                                      outcome_columns,
                                      collapse_to = 'age_grp')
head(ma_outcomes_tbl_fct)
```

Run the model
```{r fctrun}
ma_model_fct <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl_fct, verbose = 1)
```

And plot
```{r multi_plot2a, fig.height=3, fig.width=5}
plot(ma_model_fct, "BOSTON")
```

```{r multi_plot2b, fig.height=3, fig.width=5}
plot(ma_model_fct$`18-64`, "BOSTON", title = 'BOSTON: 18-64')
```

```{r multi_plot2c, fig.height=5, fig.width=5}
forest_plot(ma_model_fct, 25.1)
```

```{r multi_plot2d, fig.height=10, fig.width=6}
spatial_plot(ma_model_fct, shp = ma_towns, exposure_val = 25.1)
```
