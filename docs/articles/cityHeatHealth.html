<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting started with `cityHeatHealth` • cityHeatHealth</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Getting started with `cityHeatHealth`">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cityHeatHealth</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/cityHeatHealth.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/one_stage_demo.html">One set of Heat-Health Associations for a single or multiple zones using `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/two_stage_demo.html">Heat-Health Associations across multiple towns using `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian_demo.html">Using Spatial Bayesian methods in `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/attributable_number.html">Calculating attributable numbers and rates in `cityHeatHealth`</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting started with `cityHeatHealth`</h1>
            
      

      <div class="d-none name"><code>cityHeatHealth.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="getting-started-with-cityheathealth">Getting started with <code>cityHeatHealth</code><a class="anchor" aria-label="anchor" href="#getting-started-with-cityheathealth"></a>
</h2>
<p>Here is code that shows the basic skeleton of how this package works.
We can run the model and then calculate attributable numbers easily, and
provide a number of outputs.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://chadmilando.com/cityHeatHealth/">cityHeatHealth</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-the-model">Run the model<a class="anchor" aria-label="anchor" href="#run-the-model"></a>
</h2>
<div class="section level3">
<h3 id="exposure">Exposure<a class="anchor" aria-label="anchor" href="#exposure"></a>
</h3>
<p>First, create the exposure object - you will need to define the
<code>exposure_columns</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load a built-in dataset and get a subset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ma_exposure"</span><span class="op">)</span> </span>
<span><span class="va">exposure_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ma_exposure</span>,<span class="va">COUNTY20</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'MIDDLESEX'</span>, <span class="st">'WORCESTER'</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>           <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2012</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define columns of ma_exposure</span></span>
<span><span class="va">exposure_columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"date"</span> <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  <span class="st">"exposure"</span> <span class="op">=</span> <span class="st">"tmax_C"</span>,</span>
<span>  <span class="st">"geo_unit"</span> <span class="op">=</span> <span class="st">"TOWN20"</span>,</span>
<span>  <span class="st">"geo_unit_grp"</span> <span class="op">=</span> <span class="st">"COUNTY20"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create the object</span></span>
<span><span class="va">ma_exposure_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_exposure_matrix.html">make_exposure_matrix</a></span><span class="op">(</span><span class="va">exposure_sub</span>, <span class="va">exposure_columns</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in make_exposure_matrix(exposure_sub, exposure_columns): check about any NA, some corrections for this later,</span></span>
<span><span class="co">#&gt;             but only in certain columns</span></span></code></pre></div>
<p>And lets preview this</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ma_exposure_matrix</span><span class="op">)</span></span>
<span><span class="co">#&gt;          date  tmax_C     TOWN20  COUNTY20 explag1 explag2 explag3 explag4</span></span>
<span><span class="co">#&gt;        &lt;Date&gt;   &lt;num&gt;     &lt;char&gt;    &lt;char&gt;   &lt;num&gt;   &lt;num&gt;   &lt;num&gt;   &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 2012-05-01 16.4633      ACTON MIDDLESEX 14.0179 14.1931 12.7975 17.5538</span></span>
<span><span class="co">#&gt; 2: 2012-05-01 16.5767  ARLINGTON MIDDLESEX 14.1291 14.2293 12.7909 17.6980</span></span>
<span><span class="co">#&gt; 3: 2012-05-01 16.5619 ASHBURNHAM WORCESTER 11.8703 11.8568  5.5348 14.4481</span></span>
<span><span class="co">#&gt; 4: 2012-05-01 15.5823      ASHBY MIDDLESEX 14.0730 14.2239 12.9341 17.1079</span></span>
<span><span class="co">#&gt; 5: 2012-05-01 16.3266    ASHLAND MIDDLESEX 13.8454 14.1018 12.7003 17.3625</span></span>
<span><span class="co">#&gt; 6: 2012-05-01 16.2456      ATHOL WORCESTER 14.1087 11.9718  8.0548 13.9967</span></span>
<span><span class="co">#&gt;    explag5</span></span>
<span><span class="co">#&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 16.2753</span></span>
<span><span class="co">#&gt; 2: 16.2485</span></span>
<span><span class="co">#&gt; 3: 11.0525</span></span>
<span><span class="co">#&gt; 4: 16.3154</span></span>
<span><span class="co">#&gt; 5: 16.1076</span></span>
<span><span class="co">#&gt; 6: 11.8158</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="outcome">Outcome<a class="anchor" aria-label="anchor" href="#outcome"></a>
</h3>
<p>Next, create the outcome object. As seen in other tutorials, you can
<code>collapse_to</code> a factor level and get outputs that way later
on.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load a built-in dataset, and get a subset, for speed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ma_deaths"</span><span class="op">)</span> </span>
<span><span class="va">deaths_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ma_deaths</span>,<span class="va">COUNTY20</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'MIDDLESEX'</span>, <span class="st">'WORCESTER'</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>           <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2012</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define columns of ma_deaths</span></span>
<span><span class="va">outcome_columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"date"</span> <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  <span class="st">"outcome"</span> <span class="op">=</span> <span class="st">"daily_deaths"</span>,</span>
<span>  <span class="st">"factor"</span> <span class="op">=</span> <span class="st">'age_grp'</span>,</span>
<span>  <span class="st">"factor"</span> <span class="op">=</span> <span class="st">'sex'</span>,</span>
<span>  <span class="st">"geo_unit"</span> <span class="op">=</span> <span class="st">"TOWN20"</span>,</span>
<span>  <span class="st">"geo_unit_grp"</span> <span class="op">=</span> <span class="st">"COUNTY20"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create the object</span></span>
<span><span class="va">ma_outcomes_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_outcome_table.html">make_outcome_table</a></span><span class="op">(</span><span class="va">deaths_sub</span>, <span class="va">outcome_columns</span><span class="op">)</span></span></code></pre></div>
<p>And lets preview this</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ma_outcomes_tbl</span><span class="op">)</span></span>
<span><span class="co">#&gt;          date     TOWN20  COUNTY20 daily_deaths                     strata</span></span>
<span><span class="co">#&gt;        &lt;Date&gt;     &lt;char&gt;    &lt;char&gt;        &lt;int&gt;                     &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 2012-05-01      ACTON MIDDLESEX           73      ACTON:yr2012:mn5:dow3</span></span>
<span><span class="co">#&gt; 2: 2012-05-01  ARLINGTON MIDDLESEX          148  ARLINGTON:yr2012:mn5:dow3</span></span>
<span><span class="co">#&gt; 3: 2012-05-01 ASHBURNHAM WORCESTER           15 ASHBURNHAM:yr2012:mn5:dow3</span></span>
<span><span class="co">#&gt; 4: 2012-05-01      ASHBY MIDDLESEX           10      ASHBY:yr2012:mn5:dow3</span></span>
<span><span class="co">#&gt; 5: 2012-05-01    ASHLAND MIDDLESEX           48    ASHLAND:yr2012:mn5:dow3</span></span>
<span><span class="co">#&gt; 6: 2012-05-01      ATHOL WORCESTER           36      ATHOL:yr2012:mn5:dow3</span></span>
<span><span class="co">#&gt;    strata_total</span></span>
<span><span class="co">#&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:          423</span></span>
<span><span class="co">#&gt; 2:          781</span></span>
<span><span class="co">#&gt; 3:           81</span></span>
<span><span class="co">#&gt; 4:           42</span></span>
<span><span class="co">#&gt; 5:          254</span></span>
<span><span class="co">#&gt; 6:          189</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-the-conditional-poisson-model">Run the conditional poisson model<a class="anchor" aria-label="anchor" href="#run-the-conditional-poisson-model"></a>
</h3>
<p>we then run a conditional poisson model.</p>
<div class="section level4">
<h4 id="cross-basis-arguments">Cross-basis arguments<a class="anchor" aria-label="anchor" href="#cross-basis-arguments"></a>
</h4>
<p>There are built-in arguments for <code>argvar</code> and
<code>arglag</code> that you can override if you’d like, but the
defaults are:</p>
<ul>
<li>
<code>maxlag</code>: default is 5 (days)</li>
<li>
<code>argvar</code>: default is <code>ns()</code> and knots at the
50th and 90th percentile of unit-specific exposure.</li>
<li>
<code>arglag</code>: default is
<code>list(fun = 'ns', knots = logknots(maxlag, nk = 2))</code>
</li>
</ul>
<p>You can also affect the global centering point:</p>
<ul>
<li>the default behavior is <code>global_cen = NULL</code>, meaning that
the mininum RR will be used</li>
<li>you can override this by setting <code>global_cen</code>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="model-types">Model types<a class="anchor" aria-label="anchor" href="#model-types"></a>
</h4>
<p>Now you have several options for running the conditional poisson
model:</p>
<table tbl-colwidths="[10,10,80]" class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Design</th>
<th>Function</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>1-stage design</strong></td>
<td><code>condPois_1stage</code></td>
<td>Produces a single set beta coefficients across all included spatial
units. If multiple <code>geo_units</code> are present in the input
objects, <code>multi_zone = TRUE</code> must be set. This option does
not use <code>mixmeta</code> or <code>blup</code>.</td>
</tr>
<tr class="even">
<td><strong>2-stage design</strong></td>
<td><code>condPois_2stage</code></td>
<td>Estimates beta coefficients for each spatial unit and then uses
<code>mixmeta</code> and <code>blup</code> to obtain more stable
estimates.</td>
</tr>
<tr class="odd">
<td><strong>Spatial Bayes</strong></td>
<td><code>condPois_sb</code></td>
<td>Also estimates beta coefficients for each spatial unit, but applies
Bayesian methods to stabilize estimates by borrowing information from
neighboring spatial units, rather than from the full dataset as in
<code>mixmeta</code>. This approach is especially useful in settings
with small outcome numbers.</td>
</tr>
</tbody>
</table>
<p>We show code for each but just run <code>condPois_2stage</code> in
this vignette.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condPois_2stage.html">condPois_2stage</a></span><span class="op">(</span><span class="va">ma_exposure_matrix</span>, <span class="va">ma_outcomes_tbl</span><span class="op">)</span></span></code></pre></div>
<p>For <code>condPois_1stage</code> the call would look like this, where
you’d need to add the argument <code>multi_zone = T</code> because there
are multiple <code>geo_units</code> in
<code>ma_exposure_matrix</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condPois_1stage.html">condPois_1stage</a></span><span class="op">(</span><span class="va">ma_exposure_matrix</span>, <span class="va">ma_outcomes_tbl</span>, multi_zone <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>See <code><a href="../articles/one_stage_demo.html">vignette("one_stage_demo")</a></code> for more details. Note
that <code>forest_plot</code> and <code>spatial_plot</code> are not
implemented for <code>condPois_1stage</code> since you can get all of
that information from the RR plot.</p>
<p>And for <code>condPois_sb</code>, the only additional information
you’d need is a shapefile showing how the <code>geo_unit</code>s are
arranged, in this case <code>ma_towns</code> (in a test run this code
took 20 minutes to complete for the full MA dataset [with maybe some
additional bugs to work out]):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ma_towns"</span><span class="op">)</span></span>
<span><span class="va">ma_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condPois_sb.html">condPois_sb</a></span><span class="op">(</span><span class="va">ma_exposure_matrix</span>, <span class="va">ma_outcomes_tbl</span>, <span class="va">ma_towns</span><span class="op">)</span></span></code></pre></div>
<p>See <code><a href="../articles/bayesian_demo.html">vignette("bayesian_demo")</a></code> for more details.</p>
</div>
</div>
<div class="section level3">
<h3 id="plot-outputs">Plot outputs<a class="anchor" aria-label="anchor" href="#plot-outputs"></a>
</h3>
<p>And are several plots you can make.</p>
<p>First, a basic RR plot by <code>geo_unit</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_model</span>, <span class="st">"CAMBRIDGE"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/plot1-1.png" class="r-plt" width="480"></p>
<p>You can also make a forest plot at a specific exposure value</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/forest_plot.html">forest_plot</a></span><span class="op">(</span><span class="va">ma_model</span>, exposure_val <span class="op">=</span> <span class="fl">25.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in forest_plot.condPois_2stage(ma_model, exposure_val = 25.1): plotting</span></span>
<span><span class="co">#&gt; by group since n_geos &gt; 20</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/forest_plot-1.png" class="r-plt" width="480"></p>
<p>You can also make a spatial plot at a specific exposure value:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatial_plot.html">spatial_plot</a></span><span class="op">(</span><span class="va">ma_model</span>, shp <span class="op">=</span> <span class="va">ma_towns</span>, exposure_val <span class="op">=</span> <span class="fl">25.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/spatial_plot-1.png" class="r-plt" width="480"></p>
</div>
<div class="section level3">
<h3 id="getrr">getRR<a class="anchor" aria-label="anchor" href="#getrr"></a>
</h3>
<p>For your own purposes, each of these objects has a <code>getRR</code>
function</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getRR.html">getRR</a></span><span class="op">(</span><span class="va">ma_model</span><span class="op">)</span></span>
<span><span class="co">#&gt;           TOWN20  COUNTY20 tmax_C       RR      RRlb     RRub     model_class</span></span>
<span><span class="co">#&gt;           &lt;char&gt;    &lt;char&gt;  &lt;num&gt;    &lt;num&gt;     &lt;num&gt;    &lt;num&gt;          &lt;char&gt;</span></span>
<span><span class="co">#&gt;     1:     ACTON MIDDLESEX    7.0 1.000000 1.0000000 1.000000 condPois_2stage</span></span>
<span><span class="co">#&gt;     2:     ACTON MIDDLESEX    7.1 1.000516 0.9999447 1.001088 condPois_2stage</span></span>
<span><span class="co">#&gt;     3:     ACTON MIDDLESEX    7.2 1.001033 0.9998894 1.002177 condPois_2stage</span></span>
<span><span class="co">#&gt;     4:     ACTON MIDDLESEX    7.3 1.001549 0.9998343 1.003267 condPois_2stage</span></span>
<span><span class="co">#&gt;     5:     ACTON MIDDLESEX    7.4 1.002067 0.9997795 1.004359 condPois_2stage</span></span>
<span><span class="co">#&gt;    ---                                                                       </span></span>
<span><span class="co">#&gt; 32510: WORCESTER WORCESTER   33.6 1.288946 1.2000454 1.384432 condPois_2stage</span></span>
<span><span class="co">#&gt; 32511: WORCESTER WORCESTER   33.7 1.290732 1.2010888 1.387065 condPois_2stage</span></span>
<span><span class="co">#&gt; 32512: WORCESTER WORCESTER   33.8 1.292520 1.2021282 1.389709 condPois_2stage</span></span>
<span><span class="co">#&gt; 32513: WORCESTER WORCESTER   33.9 1.294311 1.2031641 1.392363 condPois_2stage</span></span>
<span><span class="co">#&gt; 32514: WORCESTER WORCESTER   34.0 1.296105 1.2041968 1.395027 condPois_2stage</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="calculate-attributable-numbers">Calculate attributable numbers<a class="anchor" aria-label="anchor" href="#calculate-attributable-numbers"></a>
</h2>
<p>See more details in <code><a href="../articles/attributable_number.html">vignette("attributable_number")</a></code>, but
here is a brief demo</p>
<div class="section level3">
<h3 id="population-data">Population data<a class="anchor" aria-label="anchor" href="#population-data"></a>
</h3>
<p>The first step of calculating attributable numbers is having a
population data estimate.</p>
<p>This varies a lot by place and dataset, so we don’t include
functionality for it (but an example of how this could be done can be
seen in <code><a href="../articles/get_pop_estimates.html">vignette("get_pop_estimates")</a></code>).</p>
<p>Assume you are starting with a dataset for the entire timeframe that
looks like this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ma_pop_data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">ma_pop_data</span><span class="op">)</span></span>
<span><span class="va">ma_pop_data</span></span>
<span><span class="co">#&gt;               TOWN20 Female_0-17 Female_18-64 Female_65+ Male_0-17 Male_18-64</span></span>
<span><span class="co">#&gt;               &lt;char&gt;       &lt;num&gt;        &lt;num&gt;      &lt;num&gt;     &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:      BARNSTABLE        3899        15017       6014      4499      14035</span></span>
<span><span class="co">#&gt;   2:          BOURNE        1891         5751       3212      1489       5302</span></span>
<span><span class="co">#&gt;   3:        BREWSTER         634         2518       2007       833       2628</span></span>
<span><span class="co">#&gt;   4:         CHATHAM         163         1477       1759       480       1265</span></span>
<span><span class="co">#&gt;   5:          DENNIS         573         3792       3133       784       4101</span></span>
<span><span class="co">#&gt;  ---                                                                         </span></span>
<span><span class="co">#&gt; 347:   WEST BOYLSTON         619         2021       1107       604       2554</span></span>
<span><span class="co">#&gt; 348: WEST BROOKFIELD         343         1162        578       243       1002</span></span>
<span><span class="co">#&gt; 349:     WESTMINSTER         847         2371       1131       762       2028</span></span>
<span><span class="co">#&gt; 350:      WINCHENDON        1254         3318        711      1031       3134</span></span>
<span><span class="co">#&gt; 351:       WORCESTER       18779        67750      15995     21129      69365</span></span>
<span><span class="co">#&gt;      Male_65+</span></span>
<span><span class="co">#&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     5458</span></span>
<span><span class="co">#&gt;   2:     2810</span></span>
<span><span class="co">#&gt;   3:     1721</span></span>
<span><span class="co">#&gt;   4:     1463</span></span>
<span><span class="co">#&gt;   5:     2359</span></span>
<span><span class="co">#&gt;  ---         </span></span>
<span><span class="co">#&gt; 347:      790</span></span>
<span><span class="co">#&gt; 348:      495</span></span>
<span><span class="co">#&gt; 349:     1081</span></span>
<span><span class="co">#&gt; 350:      924</span></span>
<span><span class="co">#&gt; 351:    11173</span></span></code></pre></div>
<p>Need to do some transformations:</p>
<ul>
<li>pivot longer</li>
<li>variable clean</li>
</ul>
<p>Note again, this processing will vary by application so this approach
is not prescriptive !</p>
<p>Pivot longer:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_pop_data_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>  <span class="va">ma_pop_data</span>,</span>
<span>  id.vars <span class="op">=</span> <span class="st">"TOWN20"</span>,</span>
<span>  variable.name <span class="op">=</span> <span class="st">"sex_age"</span>,</span>
<span>  value.name <span class="op">=</span> <span class="st">"population"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Variable clean:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span><span class="op">)</span></span>
<span><span class="va">varnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span>, <span class="st">"_"</span>, fixed <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">varnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">varnames</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">varnames</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'sex'</span>, <span class="st">'age_grp'</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="st">'Female'</span><span class="op">)</span></span>
<span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span><span class="op">[</span><span class="va">rr</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'F'</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="st">'Male'</span><span class="op">)</span></span>
<span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span><span class="op">[</span><span class="va">rr</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'M'</span></span>
<span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex</span> <span class="op">=</span> <span class="va">varnames</span><span class="op">$</span><span class="va">sex</span></span>
<span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">age_grp</span> <span class="op">=</span> <span class="va">varnames</span><span class="op">$</span><span class="va">age_grp</span></span>
<span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>Lets look at it:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_pop_data_long</span></span>
<span><span class="co">#&gt;                TOWN20 population    sex age_grp</span></span>
<span><span class="co">#&gt;                &lt;char&gt;      &lt;num&gt; &lt;char&gt;  &lt;char&gt;</span></span>
<span><span class="co">#&gt;    1:      BARNSTABLE       3899      F    0-17</span></span>
<span><span class="co">#&gt;    2:          BOURNE       1891      F    0-17</span></span>
<span><span class="co">#&gt;    3:        BREWSTER        634      F    0-17</span></span>
<span><span class="co">#&gt;    4:         CHATHAM        163      F    0-17</span></span>
<span><span class="co">#&gt;    5:          DENNIS        573      F    0-17</span></span>
<span><span class="co">#&gt;   ---                                          </span></span>
<span><span class="co">#&gt; 2102:   WEST BOYLSTON        790      M     65+</span></span>
<span><span class="co">#&gt; 2103: WEST BROOKFIELD        495      M     65+</span></span>
<span><span class="co">#&gt; 2104:     WESTMINSTER       1081      M     65+</span></span>
<span><span class="co">#&gt; 2105:      WINCHENDON        924      M     65+</span></span>
<span><span class="co">#&gt; 2106:       WORCESTER      11173      M     65+</span></span></code></pre></div>
<p>We assume that these properties hold for the entire timeframe of our
analysis, but you could also make a version of this dataset with a
‘year’ column.</p>
</div>
<div class="section level3">
<h3 id="calculate-an">Calculate AN<a class="anchor" aria-label="anchor" href="#calculate-an"></a>
</h3>
<p>Now, you can easily calculate attributrable numbers (and rates) using
<code>calcAN()</code>.</p>
<p>There are two new inputs that this function needs, in addition to
population data:</p>
<ul>
<li>
<code>agg_type</code> - what spatial resolution are you summarizing
to: ‘geo_unit’, ‘geo_unit_grp’, or ‘all’</li>
<li>
<code>join_cols</code> - which columns in
<code>ma_outcomes_tbl</code> are you joining
<code>ma_pop_data_long</code> by</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_AN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_AN.html">calc_AN</a></span><span class="op">(</span><span class="va">ma_model</span>, <span class="va">ma_outcomes_tbl</span>, <span class="va">ma_pop_data_long</span>,</span>
<span>                 agg_type <span class="op">=</span> <span class="st">'TOWN20'</span>, join_cols <span class="op">=</span> <span class="st">'TOWN20'</span><span class="op">)</span></span></code></pre></div>
<p>From this you get a <code>rate_table</code> :</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_AN</span><span class="op">$</span><span class="va">`_`</span><span class="op">$</span><span class="va">rate_table</span></span>
<span><span class="co">#&gt;          TOWN20  COUNTY20 population above_MMT mean_annual_attr_rate_est</span></span>
<span><span class="co">#&gt;          &lt;char&gt;    &lt;char&gt;      &lt;num&gt;    &lt;lgcl&gt;                     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:      ACTON MIDDLESEX      23864      TRUE                  24.56105</span></span>
<span><span class="co">#&gt;   2:      ACTON MIDDLESEX      23864     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;   3:  ARLINGTON MIDDLESEX      45906      TRUE                  30.11861</span></span>
<span><span class="co">#&gt;   4:  ARLINGTON MIDDLESEX      45906     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;   5: ASHBURNHAM WORCESTER       6337      TRUE                  21.44153</span></span>
<span><span class="co">#&gt;  ---                                                                    </span></span>
<span><span class="co">#&gt; 224: WINCHESTER MIDDLESEX      22809     FALSE                   0.00000</span></span>
<span><span class="co">#&gt; 225:     WOBURN MIDDLESEX      40992      TRUE                  22.50236</span></span>
<span><span class="co">#&gt; 226:     WOBURN MIDDLESEX      40992     FALSE                   0.00000</span></span>
<span><span class="co">#&gt; 227:  WORCESTER WORCESTER     204191      TRUE                  25.62654</span></span>
<span><span class="co">#&gt; 228:  WORCESTER WORCESTER     204191     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;      mean_annual_attr_rate_lb mean_annual_attr_rate_ub</span></span>
<span><span class="co">#&gt;                         &lt;num&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:                 14.16036                 34.49521</span></span>
<span><span class="co">#&gt;   2:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt;   3:                 21.05122                 38.09419</span></span>
<span><span class="co">#&gt;   4:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt;   5:                 13.12398                 29.34617</span></span>
<span><span class="co">#&gt;  ---                                                  </span></span>
<span><span class="co">#&gt; 224:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt; 225:                 14.48530                 29.36996</span></span>
<span><span class="co">#&gt; 226:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt; 227:                 15.26067                 34.07675</span></span>
<span><span class="co">#&gt; 228:                  0.00000                  0.00000</span></span></code></pre></div>
<p>and a <code>number_table</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_AN</span><span class="op">$</span><span class="va">`_`</span><span class="op">$</span><span class="va">number_table</span></span>
<span><span class="co">#&gt;          TOWN20  COUNTY20 population above_MMT mean_annual_attr_num_est</span></span>
<span><span class="co">#&gt;          &lt;char&gt;    &lt;char&gt;      &lt;num&gt;    &lt;lgcl&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:      ACTON MIDDLESEX      23864      TRUE                 5.861250</span></span>
<span><span class="co">#&gt;   2:      ACTON MIDDLESEX      23864     FALSE                 0.000000</span></span>
<span><span class="co">#&gt;   3:  ARLINGTON MIDDLESEX      45906      TRUE                13.826250</span></span>
<span><span class="co">#&gt;   4:  ARLINGTON MIDDLESEX      45906     FALSE                 0.000000</span></span>
<span><span class="co">#&gt;   5: ASHBURNHAM WORCESTER       6337      TRUE                 1.358750</span></span>
<span><span class="co">#&gt;  ---                                                                   </span></span>
<span><span class="co">#&gt; 224: WINCHESTER MIDDLESEX      22809     FALSE                 0.000000</span></span>
<span><span class="co">#&gt; 225:     WOBURN MIDDLESEX      40992      TRUE                 9.224167</span></span>
<span><span class="co">#&gt; 226:     WOBURN MIDDLESEX      40992     FALSE                 0.000000</span></span>
<span><span class="co">#&gt; 227:  WORCESTER WORCESTER     204191      TRUE                52.327083</span></span>
<span><span class="co">#&gt; 228:  WORCESTER WORCESTER     204191     FALSE                 0.000000</span></span>
<span><span class="co">#&gt;      mean_annual_attr_num_lb mean_annual_attr_num_ub</span></span>
<span><span class="co">#&gt;                        &lt;num&gt;                   &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:               3.3792292                8.231937</span></span>
<span><span class="co">#&gt;   2:               0.0000000                0.000000</span></span>
<span><span class="co">#&gt;   3:               9.6637708               17.487521</span></span>
<span><span class="co">#&gt;   4:               0.0000000                0.000000</span></span>
<span><span class="co">#&gt;   5:               0.8316667                1.859667</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 224:               0.0000000                0.000000</span></span>
<span><span class="co">#&gt; 225:               5.9378125               12.039333</span></span>
<span><span class="co">#&gt; 226:               0.0000000                0.000000</span></span>
<span><span class="co">#&gt; 227:              31.1609167               69.581667</span></span>
<span><span class="co">#&gt; 228:               0.0000000                0.000000</span></span></code></pre></div>
<p>And you can plot either one</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_AN</span>, <span class="st">"num"</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in plot.calcAN(ma_AN, "num", above_MMT = T): plot elements &gt; 20,</span></span>
<span><span class="co">#&gt; subsetting to top 20</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/calcAN_plot-1.png" class="r-plt" width="768"></p>
<p>You can also plot spatially</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatial_plot.html">spatial_plot</a></span><span class="op">(</span><span class="va">ma_AN</span>, shp <span class="op">=</span> <span class="va">ma_towns</span>, table_type <span class="op">=</span> <span class="st">"num"</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/multi_plot3d-1.png" class="r-plt" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="running-with-factors">Running with factors<a class="anchor" aria-label="anchor" href="#running-with-factors"></a>
</h2>
<p>Very often, we also get asked to run these results, with differences
by both modifiable and non-modifiable factors:</p>
<ul>
<li>age group</li>
<li>sex</li>
<li>the prevalence of air conditioning in a certain town</li>
</ul>
<p>We can easily do this, by using the <code>collapse_to</code>
argument:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_outcomes_tbl_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_outcome_table.html">make_outcome_table</a></span><span class="op">(</span></span>
<span>  <span class="va">deaths_sub</span>, <span class="va">outcome_columns</span>, collapse_to <span class="op">=</span> <span class="st">'age_grp'</span><span class="op">)</span></span></code></pre></div>
<p>Lets look at the result:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ma_outcomes_tbl_fct</span><span class="op">)</span></span>
<span><span class="co">#&gt;          date    TOWN20  COUNTY20 age_grp daily_deaths</span></span>
<span><span class="co">#&gt;        &lt;Date&gt;    &lt;char&gt;    &lt;char&gt;  &lt;char&gt;        &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1: 2012-05-01     ACTON MIDDLESEX    0-17           25</span></span>
<span><span class="co">#&gt; 2: 2012-05-01     ACTON MIDDLESEX   18-64           24</span></span>
<span><span class="co">#&gt; 3: 2012-05-01     ACTON MIDDLESEX     65+           24</span></span>
<span><span class="co">#&gt; 4: 2012-05-01 ARLINGTON MIDDLESEX    0-17           50</span></span>
<span><span class="co">#&gt; 5: 2012-05-01 ARLINGTON MIDDLESEX   18-64           48</span></span>
<span><span class="co">#&gt; 6: 2012-05-01 ARLINGTON MIDDLESEX     65+           50</span></span>
<span><span class="co">#&gt;                                    strata strata_total</span></span>
<span><span class="co">#&gt;                                    &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      ACTON:yr2012:mn5:dow3:age_grp0-17          147</span></span>
<span><span class="co">#&gt; 2:     ACTON:yr2012:mn5:dow3:age_grp18-64          136</span></span>
<span><span class="co">#&gt; 3:       ACTON:yr2012:mn5:dow3:age_grp65+          140</span></span>
<span><span class="co">#&gt; 4:  ARLINGTON:yr2012:mn5:dow3:age_grp0-17          270</span></span>
<span><span class="co">#&gt; 5: ARLINGTON:yr2012:mn5:dow3:age_grp18-64          249</span></span>
<span><span class="co">#&gt; 6:   ARLINGTON:yr2012:mn5:dow3:age_grp65+          262</span></span></code></pre></div>
<p>Now, all of our other functions can stay the same:</p>
<p>Running the model (adding the <code>verbose</code> argument so you
can follow along)</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_model_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condPois_2stage.html">condPois_2stage</a></span><span class="op">(</span><span class="va">ma_exposure_matrix</span>, <span class="va">ma_outcomes_tbl_fct</span>,</span>
<span>                                verbose <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt; age_grp : 0-17 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- stage 1</span></span>
<span><span class="co">#&gt; -- mixmeta</span></span>
<span><span class="co">#&gt; -- stage 2</span></span>
<span><span class="co">#&gt; &lt; age_grp : 18-64 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- stage 1</span></span>
<span><span class="co">#&gt; -- mixmeta</span></span>
<span><span class="co">#&gt; -- stage 2</span></span>
<span><span class="co">#&gt; &lt; age_grp : 65+ &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- stage 1</span></span>
<span><span class="co">#&gt; -- mixmeta</span></span>
<span><span class="co">#&gt; -- stage 2</span></span></code></pre></div>
<p>And plotting the output</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_model_fct</span>, <span class="st">"CAMBRIDGE"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/plot1b-1.png" class="r-plt" width="480"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/forest_plot.html">forest_plot</a></span><span class="op">(</span><span class="va">ma_model_fct</span>, exposure_val <span class="op">=</span> <span class="fl">25.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in forest_plot.condPois_2stage_list(ma_model_fct, exposure_val = 25.1):</span></span>
<span><span class="co">#&gt; plotting by group since n_geos &gt; 20</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/forest_plot2b-1.png" class="r-plt" width="480"></p>
<p>You can also make a spatial plot at a specific exposure value:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatial_plot.html">spatial_plot</a></span><span class="op">(</span><span class="va">ma_model_fct</span>, shp <span class="op">=</span> <span class="va">ma_towns</span>, exposure_val <span class="op">=</span> <span class="fl">25.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/spatial_plot2-1.png" class="r-plt" width="480"></p>
<p>You can also getRR:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getRR.html">getRR</a></span><span class="op">(</span><span class="va">ma_model_fct</span><span class="op">)</span></span>
<span><span class="co">#&gt;           TOWN20  COUNTY20 tmax_C       RR      RRlb     RRub age_grp</span></span>
<span><span class="co">#&gt;           &lt;char&gt;    &lt;char&gt;  &lt;num&gt;    &lt;num&gt;     &lt;num&gt;    &lt;num&gt;  &lt;char&gt;</span></span>
<span><span class="co">#&gt;     1:     ACTON MIDDLESEX    7.0 1.000000 1.0000000 1.000000    0-17</span></span>
<span><span class="co">#&gt;     2:     ACTON MIDDLESEX    7.1 1.000694 0.9999329 1.001456    0-17</span></span>
<span><span class="co">#&gt;     3:     ACTON MIDDLESEX    7.2 1.001389 0.9998659 1.002915    0-17</span></span>
<span><span class="co">#&gt;     4:     ACTON MIDDLESEX    7.3 1.002085 0.9997992 1.004375    0-17</span></span>
<span><span class="co">#&gt;     5:     ACTON MIDDLESEX    7.4 1.002781 0.9997327 1.005838    0-17</span></span>
<span><span class="co">#&gt;    ---                                                               </span></span>
<span><span class="co">#&gt; 97538: WORCESTER WORCESTER   33.6 1.300465 1.2147953 1.392175     65+</span></span>
<span><span class="co">#&gt; 97539: WORCESTER WORCESTER   33.7 1.302040 1.2155758 1.394654     65+</span></span>
<span><span class="co">#&gt; 97540: WORCESTER WORCESTER   33.8 1.303616 1.2163410 1.397154     65+</span></span>
<span><span class="co">#&gt; 97541: WORCESTER WORCESTER   33.9 1.305195 1.2170919 1.399676     65+</span></span>
<span><span class="co">#&gt; 97542: WORCESTER WORCESTER   34.0 1.306775 1.2178291 1.402218     65+</span></span>
<span><span class="co">#&gt;                 model_class</span></span>
<span><span class="co">#&gt;                      &lt;char&gt;</span></span>
<span><span class="co">#&gt;     1: condPois_2stage_list</span></span>
<span><span class="co">#&gt;     2: condPois_2stage_list</span></span>
<span><span class="co">#&gt;     3: condPois_2stage_list</span></span>
<span><span class="co">#&gt;     4: condPois_2stage_list</span></span>
<span><span class="co">#&gt;     5: condPois_2stage_list</span></span>
<span><span class="co">#&gt;    ---                     </span></span>
<span><span class="co">#&gt; 97538: condPois_2stage_list</span></span>
<span><span class="co">#&gt; 97539: condPois_2stage_list</span></span>
<span><span class="co">#&gt; 97540: condPois_2stage_list</span></span>
<span><span class="co">#&gt; 97541: condPois_2stage_list</span></span>
<span><span class="co">#&gt; 97542: condPois_2stage_list</span></span></code></pre></div>
<p>And finally, you can <code>calcAN</code>, note that both
<code>ma_outcomes_tbl_fct</code> and <code>ma_model_fct</code> need to
have factors, again adding the verbose so you can see the progress</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_AN_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_AN.html">calc_AN</a></span><span class="op">(</span><span class="va">ma_model_fct</span>, </span>
<span>                     <span class="va">ma_outcomes_tbl_fct</span>, </span>
<span>                     <span class="va">ma_pop_data_long</span>,</span>
<span>                 agg_type <span class="op">=</span> <span class="st">'TOWN20'</span>, join_cols <span class="op">=</span> <span class="st">'TOWN20'</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt; age_grp : 0-17 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span><span class="co">#&gt; &lt; age_grp : 18-64 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span><span class="co">#&gt; &lt; age_grp : 65+ &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span></code></pre></div>
<p>And you can plot either one – some empty bars not because there are
no adults there but because this takes the top 20 in each bin, which
don’t have to overlap. Probably a better way to do this in the future
but fine for diagnostics.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_AN_fct</span>, <span class="st">"num"</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in plot.calcAN_list(ma_AN_fct, "num", above_MMT = T): plot elements &gt;</span></span>
<span><span class="co">#&gt; 20, subsetting to top 20</span></span>
<span><span class="co">#&gt; Warning in plot.calcAN_list(ma_AN_fct, "num", above_MMT = T): plot elements &gt;</span></span>
<span><span class="co">#&gt; 20, subsetting to top 20</span></span>
<span><span class="co">#&gt; Warning in plot.calcAN_list(ma_AN_fct, "num", above_MMT = T): plot elements &gt;</span></span>
<span><span class="co">#&gt; 20, subsetting to top 20</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/calcAN_plot2-1.png" class="r-plt" width="768"></p>
<p>You can also plot spatially</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatial_plot.html">spatial_plot</a></span><span class="op">(</span><span class="va">ma_AN_fct</span>, shp <span class="op">=</span> <span class="va">ma_towns</span>, table_type <span class="op">=</span> <span class="st">"num"</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="cityHeatHealth_files/figure-html/multi_plot3db-1.png" class="r-plt" width="576"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://chadmilando.com" class="external-link">Chad Milando</a>, <a href="https://www.bu.edu/sph/profile/emma-gause/" class="external-link">Emma Gause</a>, <a href="https://www.colorado.edu/oclab/quinn-adams" class="external-link">Quinn Adams</a>, <a href="https://www.bu.edu/sph/profile/zachary-popp/" class="external-link">Zachary Popp</a>, <a href="https://www.bu.edu/sph/profile/gregory-wellenius/" class="external-link">Gregory Wellenius</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
