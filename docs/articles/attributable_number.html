<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calculating attributable numbers and rates in `cityHeatHealth` • cityHeatHealth</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calculating attributable numbers and rates in `cityHeatHealth`">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cityHeatHealth</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/attributable_number.html">Calculating attributable numbers and rates in `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian_demo.html">Using Spatial Bayesian methods in `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/comparison.html">Comparison of `cityHeatHealth` to other AN tutorials</a></li>
    <li><a class="dropdown-item" href="../articles/dlnm_sensitivity.html">Exploring DLNM sensitivity in `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">faq</a></li>
    <li><a class="dropdown-item" href="../articles/get_pop_estimates.html">Obtaining population estimates from `tidycensus`</a></li>
    <li><a class="dropdown-item" href="../articles/group-check.html">group-check</a></li>
    <li><a class="dropdown-item" href="../articles/one_stage_demo.html">One set of Heat-Health Associations for a single or multiple zones using `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart guide to `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/two_stage_demo.html">Heat-Health Associations across multiple towns using `cityHeatHealth`</a></li>
    <li><a class="dropdown-item" href="../articles/validation.html">Validation of spatial methods in `cityHeatHealth`</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calculating attributable numbers and rates in `cityHeatHealth`</h1>
            
      

      <div class="d-none name"><code>attributable_number.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://chadmilando.com/cityHeatHealth/">cityHeatHealth</a></span><span class="op">)</span></span></code></pre></div>
<p>Estimating Attributable numbers (and rates of attributable numbers)
are a key way that we can translate relative risks into numbers that are
more tangible in public health settings. Below we provide easy
functionality to go from our model objects to estimates of attributable
numbers and rates.</p>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>The first step of calculating attributable numbers is having a
population data estimate.</p>
<p>This varies a lot by place and dataset, so we don’t include
functionality for it (but an example of how this could be done can be
seen in <code><a href="../articles/get_pop_estimates.html">vignette("get_pop_estimates")</a></code>).</p>
<p>Assume you are starting with a dataset for the entire timeframe that
looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ma_pop_data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">ma_pop_data</span><span class="op">)</span></span>
<span><span class="va">ma_pop_data</span></span>
<span><span class="co">#&gt;               TOWN20 Female_0-17 Female_18-64 Female_65+ Male_0-17 Male_18-64</span></span>
<span><span class="co">#&gt;               &lt;char&gt;       &lt;num&gt;        &lt;num&gt;      &lt;num&gt;     &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:      BARNSTABLE        3899        15017       6014      4499      14035</span></span>
<span><span class="co">#&gt;   2:          BOURNE        1891         5751       3212      1489       5302</span></span>
<span><span class="co">#&gt;   3:        BREWSTER         634         2518       2007       833       2628</span></span>
<span><span class="co">#&gt;   4:         CHATHAM         163         1477       1759       480       1265</span></span>
<span><span class="co">#&gt;   5:          DENNIS         573         3792       3133       784       4101</span></span>
<span><span class="co">#&gt;  ---                                                                         </span></span>
<span><span class="co">#&gt; 347:   WEST BOYLSTON         619         2021       1107       604       2554</span></span>
<span><span class="co">#&gt; 348: WEST BROOKFIELD         343         1162        578       243       1002</span></span>
<span><span class="co">#&gt; 349:     WESTMINSTER         847         2371       1131       762       2028</span></span>
<span><span class="co">#&gt; 350:      WINCHENDON        1254         3318        711      1031       3134</span></span>
<span><span class="co">#&gt; 351:       WORCESTER       18779        67750      15995     21129      69365</span></span>
<span><span class="co">#&gt;      Male_65+</span></span>
<span><span class="co">#&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:     5458</span></span>
<span><span class="co">#&gt;   2:     2810</span></span>
<span><span class="co">#&gt;   3:     1721</span></span>
<span><span class="co">#&gt;   4:     1463</span></span>
<span><span class="co">#&gt;   5:     2359</span></span>
<span><span class="co">#&gt;  ---         </span></span>
<span><span class="co">#&gt; 347:      790</span></span>
<span><span class="co">#&gt; 348:      495</span></span>
<span><span class="co">#&gt; 349:     1081</span></span>
<span><span class="co">#&gt; 350:      924</span></span>
<span><span class="co">#&gt; 351:    11173</span></span></code></pre></div>
<p>Need to do some transformations:</p>
<ul>
<li>pivot longer</li>
<li>variable clean</li>
</ul>
<p>Note again, this processing will vary by application so this approach
is not prescriptive !</p>
<p>Pivot longer:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_pop_data_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>  <span class="va">ma_pop_data</span>,</span>
<span>  id.vars <span class="op">=</span> <span class="st">"TOWN20"</span>,</span>
<span>  variable.name <span class="op">=</span> <span class="st">"sex_age"</span>,</span>
<span>  value.name <span class="op">=</span> <span class="st">"population"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Variable clean:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span><span class="op">)</span></span>
<span><span class="va">varnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span>, <span class="st">"_"</span>, fixed <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">varnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">varnames</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">varnames</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'sex'</span>, <span class="st">'age_grp'</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="st">'Female'</span><span class="op">)</span></span>
<span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span><span class="op">[</span><span class="va">rr</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'F'</span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span> <span class="op">==</span> <span class="st">'Male'</span><span class="op">)</span></span>
<span><span class="va">varnames</span><span class="op">$</span><span class="va">sex</span><span class="op">[</span><span class="va">rr</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'M'</span></span>
<span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex</span> <span class="op">=</span> <span class="va">varnames</span><span class="op">$</span><span class="va">sex</span></span>
<span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">age_grp</span> <span class="op">=</span> <span class="va">varnames</span><span class="op">$</span><span class="va">age_grp</span></span>
<span><span class="va">ma_pop_data_long</span><span class="op">$</span><span class="va">sex_age</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">ma_pop_data_long</span></span>
<span><span class="co">#&gt;                TOWN20 population    sex age_grp</span></span>
<span><span class="co">#&gt;                &lt;char&gt;      &lt;num&gt; &lt;char&gt;  &lt;char&gt;</span></span>
<span><span class="co">#&gt;    1:      BARNSTABLE       3899      F    0-17</span></span>
<span><span class="co">#&gt;    2:          BOURNE       1891      F    0-17</span></span>
<span><span class="co">#&gt;    3:        BREWSTER        634      F    0-17</span></span>
<span><span class="co">#&gt;    4:         CHATHAM        163      F    0-17</span></span>
<span><span class="co">#&gt;    5:          DENNIS        573      F    0-17</span></span>
<span><span class="co">#&gt;   ---                                          </span></span>
<span><span class="co">#&gt; 2102:   WEST BOYLSTON        790      M     65+</span></span>
<span><span class="co">#&gt; 2103: WEST BROOKFIELD        495      M     65+</span></span>
<span><span class="co">#&gt; 2104:     WESTMINSTER       1081      M     65+</span></span>
<span><span class="co">#&gt; 2105:      WINCHENDON        924      M     65+</span></span>
<span><span class="co">#&gt; 2106:       WORCESTER      11173      M     65+</span></span></code></pre></div>
<p>We assume that these properties hold for the entire timeframe of our
analysis, but you could also make a version of this dataset with a
‘year’ column.</p>
<p>Now, quickly get a <code><a href="../reference/condPois_1stage.html">condPois_1stage()</a></code> and
<code><a href="../reference/condPois_2stage.html">condPois_2stage()</a></code> objects to use in testing: exposures</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="va">exposure_columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"date"</span> <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  <span class="st">"exposure"</span> <span class="op">=</span> <span class="st">"tmax_C"</span>,</span>
<span>  <span class="st">"geo_unit"</span> <span class="op">=</span> <span class="st">"TOWN20"</span>,</span>
<span>  <span class="st">"geo_unit_grp"</span> <span class="op">=</span> <span class="st">"COUNTY20"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ma_exposure_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_exposure_matrix.html">make_exposure_matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ma_exposure</span>, <span class="va">COUNTY20</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'MIDDLESEX'</span>, <span class="st">'SUFFOLK'</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>           <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2012</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span>, </span>
<span>  <span class="va">exposure_columns</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in make_exposure_matrix(subset(ma_exposure, COUNTY20 %in% c("MIDDLESEX", : check about any NA, some corrections for this later,</span></span>
<span><span class="co">#&gt;             but only in certain columns</span></span></code></pre></div>
<p>outcomes</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcome_columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"date"</span> <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  <span class="st">"outcome"</span> <span class="op">=</span> <span class="st">"daily_deaths"</span>,</span>
<span>  <span class="st">"factor"</span> <span class="op">=</span> <span class="st">'age_grp'</span>,</span>
<span>  <span class="st">"factor"</span> <span class="op">=</span> <span class="st">'sex'</span>,</span>
<span>  <span class="st">"geo_unit"</span> <span class="op">=</span> <span class="st">"TOWN20"</span>,</span>
<span>  <span class="st">"geo_unit_grp"</span> <span class="op">=</span> <span class="st">"COUNTY20"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ma_outcomes_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_outcome_table.html">make_outcome_table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ma_deaths</span>,<span class="va">COUNTY20</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'MIDDLESEX'</span>, <span class="st">'SUFFOLK'</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>           <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2012</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span>, <span class="va">outcome_columns</span><span class="op">)</span></span></code></pre></div>
<p>models</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condPois_2stage.html">condPois_2stage</a></span><span class="op">(</span><span class="va">ma_exposure_matrix</span>, <span class="va">ma_outcomes_tbl</span>, verbose <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- stage 1</span></span>
<span><span class="co">#&gt; -- mixmeta</span></span>
<span><span class="co">#&gt; -- stage 2</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="estimating-the-an">Estimating the AN<a class="anchor" aria-label="anchor" href="#estimating-the-an"></a>
</h3>
<p>Ok so now you pass in <code>population</code>.</p>
<p>So now estimate the AN as a full object</p>
<p>Remember that this needs to be compatible for:</p>
<ul>
<li><p>single zone</p></li>
<li><p>ma model with ma_model$<code>_</code></p></li>
<li><p>ma model with factor ma_model$<code>0-17</code> &gt; I think you
can handle this the same way you did before, with recursion</p></li>
</ul>
<p>Now in this second step, you can choose the aggregation level that
you want results to.</p>
<p>In this block you need:</p>
<ul>
<li><p>what spatial resolution are you summarizing to: -&gt;&gt;
‘geo_unit’, ‘geo_unit_grp’, or ‘all’</p></li>
<li><p>are you just getting the impacts that are &gt; then the centering
point: -&gt;&gt; lets just assume yes for now, can always go back and
change it</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_AN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_AN.html">calc_AN</a></span><span class="op">(</span><span class="va">ma_model</span>, <span class="va">ma_outcomes_tbl</span>, <span class="va">ma_pop_data_long</span>,</span>
<span>                 agg_type <span class="op">=</span> <span class="st">'TOWN20'</span>, </span>
<span>                 join_cols <span class="op">=</span> <span class="st">'TOWN20'</span>, </span>
<span>                 nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; 5    10  15  20  25  30  35  40  45  50  55  </span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span><span class="co">#&gt; 5    10  15  20  25  30  35  40  45  50  55  60  65  70  75  80  85  90  95  100     </span></span>
<span><span class="va">ma_AN</span><span class="op">$</span><span class="va">`_`</span><span class="op">$</span><span class="va">rate_table</span></span>
<span><span class="co">#&gt;          TOWN20  COUNTY20 population above_MMT mean_annual_attr_rate_est</span></span>
<span><span class="co">#&gt;          &lt;char&gt;    &lt;char&gt;      &lt;num&gt;    &lt;lgcl&gt;                     &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:      ACTON MIDDLESEX      23864      TRUE                  82.79207</span></span>
<span><span class="co">#&gt;   2:      ACTON MIDDLESEX      23864     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;   3:  ARLINGTON MIDDLESEX      45906      TRUE                  87.53758</span></span>
<span><span class="co">#&gt;   4:  ARLINGTON MIDDLESEX      45906     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;   5:      ASHBY MIDDLESEX       3187      TRUE                  78.12990</span></span>
<span><span class="co">#&gt;  ---                                                                    </span></span>
<span><span class="co">#&gt; 112: WINCHESTER MIDDLESEX      22809     FALSE                   0.00000</span></span>
<span><span class="co">#&gt; 113:   WINTHROP   SUFFOLK      19031      TRUE                  89.63008</span></span>
<span><span class="co">#&gt; 114:   WINTHROP   SUFFOLK      19031     FALSE                   0.00000</span></span>
<span><span class="co">#&gt; 115:     WOBURN MIDDLESEX      40992      TRUE                  68.91284</span></span>
<span><span class="co">#&gt; 116:     WOBURN MIDDLESEX      40992     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;      mean_annual_attr_rate_lb mean_annual_attr_rate_ub</span></span>
<span><span class="co">#&gt;                         &lt;num&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:                 61.87982                105.07014</span></span>
<span><span class="co">#&gt;   2:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt;   3:                 70.11379                103.99185</span></span>
<span><span class="co">#&gt;   4:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt;   5:                 53.73588                 98.09578</span></span>
<span><span class="co">#&gt;  ---                                                  </span></span>
<span><span class="co">#&gt; 112:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt; 113:                 71.92081                105.98464</span></span>
<span><span class="co">#&gt; 114:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt; 115:                 56.00071                 85.22928</span></span>
<span><span class="co">#&gt; 116:                  0.00000                  0.00000</span></span>
<span><span class="va">ma_AN</span><span class="op">$</span><span class="va">`_`</span><span class="op">$</span><span class="va">number_table</span></span>
<span><span class="co">#&gt;          TOWN20  COUNTY20 population above_MMT mean_annual_attr_num_est</span></span>
<span><span class="co">#&gt;          &lt;char&gt;    &lt;char&gt;      &lt;num&gt;    &lt;lgcl&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:      ACTON MIDDLESEX      23864      TRUE                 19.75750</span></span>
<span><span class="co">#&gt;   2:      ACTON MIDDLESEX      23864     FALSE                  0.00000</span></span>
<span><span class="co">#&gt;   3:  ARLINGTON MIDDLESEX      45906      TRUE                 40.18500</span></span>
<span><span class="co">#&gt;   4:  ARLINGTON MIDDLESEX      45906     FALSE                  0.00000</span></span>
<span><span class="co">#&gt;   5:      ASHBY MIDDLESEX       3187      TRUE                  2.49000</span></span>
<span><span class="co">#&gt;  ---                                                                   </span></span>
<span><span class="co">#&gt; 112: WINCHESTER MIDDLESEX      22809     FALSE                  0.00000</span></span>
<span><span class="co">#&gt; 113:   WINTHROP   SUFFOLK      19031      TRUE                 17.05750</span></span>
<span><span class="co">#&gt; 114:   WINTHROP   SUFFOLK      19031     FALSE                  0.00000</span></span>
<span><span class="co">#&gt; 115:     WOBURN MIDDLESEX      40992      TRUE                 28.24875</span></span>
<span><span class="co">#&gt; 116:     WOBURN MIDDLESEX      40992     FALSE                  0.00000</span></span>
<span><span class="co">#&gt;      mean_annual_attr_num_lb mean_annual_attr_num_ub</span></span>
<span><span class="co">#&gt;                        &lt;num&gt;                   &lt;num&gt;</span></span>
<span><span class="co">#&gt;   1:               14.767000               25.073937</span></span>
<span><span class="co">#&gt;   2:                0.000000                0.000000</span></span>
<span><span class="co">#&gt;   3:               32.186437               47.738500</span></span>
<span><span class="co">#&gt;   4:                0.000000                0.000000</span></span>
<span><span class="co">#&gt;   5:                1.712563                3.126313</span></span>
<span><span class="co">#&gt;  ---                                                </span></span>
<span><span class="co">#&gt; 112:                0.000000                0.000000</span></span>
<span><span class="co">#&gt; 113:               13.687250               20.169937</span></span>
<span><span class="co">#&gt; 114:                0.000000                0.000000</span></span>
<span><span class="co">#&gt; 115:               22.955813               34.937188</span></span>
<span><span class="co">#&gt; 116:                0.000000                0.000000</span></span></code></pre></div>
<p>you can change <code>agg_type</code> to be a different spatial
resolution – either whatever the group variable was or “all”</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_AN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_AN.html">calc_AN</a></span><span class="op">(</span><span class="va">ma_model</span>, <span class="va">ma_outcomes_tbl</span>, <span class="va">ma_pop_data_long</span>,</span>
<span>                 agg_type <span class="op">=</span> <span class="st">'COUNTY20'</span>, </span>
<span>                 join_cols <span class="op">=</span> <span class="st">'TOWN20'</span>, </span>
<span>                 nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; 5    10  15  20  25  30  35  40  45  50  55  </span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span><span class="co">#&gt; 5    10  15  20  25  30  35  40  45  50  55  60  65  70  75  80  85  90  95  100     </span></span>
<span><span class="va">ma_AN</span><span class="op">$</span><span class="va">`_`</span><span class="op">$</span><span class="va">rate_table</span></span>
<span><span class="co">#&gt;     COUNTY20 population above_MMT mean_annual_attr_rate_est</span></span>
<span><span class="co">#&gt;       &lt;char&gt;      &lt;num&gt;    &lt;lgcl&gt;                     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: MIDDLESEX    1623109      TRUE                  79.71161</span></span>
<span><span class="co">#&gt; 2: MIDDLESEX    1623109     FALSE                   0.00000</span></span>
<span><span class="co">#&gt; 3:   SUFFOLK     785443      TRUE                  91.91405</span></span>
<span><span class="co">#&gt; 4:   SUFFOLK     785443     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;    mean_annual_attr_rate_lb mean_annual_attr_rate_ub</span></span>
<span><span class="co">#&gt;                       &lt;num&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                 76.87088                 81.88135</span></span>
<span><span class="co">#&gt; 2:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt; 3:                 76.72278                102.17823</span></span>
<span><span class="co">#&gt; 4:                  0.00000                  0.00000</span></span>
<span><span class="va">ma_AN</span><span class="op">$</span><span class="va">`_`</span><span class="op">$</span><span class="va">number_table</span></span>
<span><span class="co">#&gt;     COUNTY20 population above_MMT mean_annual_attr_num_est</span></span>
<span><span class="co">#&gt;       &lt;char&gt;      &lt;num&gt;    &lt;lgcl&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: MIDDLESEX    1623109      TRUE                1293.8063</span></span>
<span><span class="co">#&gt; 2: MIDDLESEX    1623109     FALSE                   0.0000</span></span>
<span><span class="co">#&gt; 3:   SUFFOLK     785443      TRUE                 721.9325</span></span>
<span><span class="co">#&gt; 4:   SUFFOLK     785443     FALSE                   0.0000</span></span>
<span><span class="co">#&gt;    mean_annual_attr_num_lb mean_annual_attr_num_ub</span></span>
<span><span class="co">#&gt;                      &lt;num&gt;                   &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:               1247.6982               1329.0236</span></span>
<span><span class="co">#&gt; 2:                  0.0000                  0.0000</span></span>
<span><span class="co">#&gt; 3:                602.6137                802.5517</span></span>
<span><span class="co">#&gt; 4:                  0.0000                  0.0000</span></span></code></pre></div>
<p>See that the numbers are roughly the same for Suffolk county ? They
won’t be exactly the same because of how the averaging works.</p>
<p>Some plot functions exist:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_AN</span>, table_type <span class="op">=</span> <span class="st">'rate'</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="attributable_number_files/figure-html/grpsum3-1.png" class="r-plt" width="768"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_AN</span>, table_type <span class="op">=</span> <span class="st">'rate'</span>, above_MMT <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<p><img src="attributable_number_files/figure-html/grpsum3-2.png" class="r-plt" width="768"></p>
</div>
<div class="section level3">
<h3 id="estimating-the-an---single">Estimating the AN - single<a class="anchor" aria-label="anchor" href="#estimating-the-an---single"></a>
</h3>
<p>check of single</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># run the model</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condPois_1stage.html">condPois_1stage</a></span><span class="op">(</span>exposure_matrix <span class="op">=</span> <span class="va">ma_exposure_matrix</span>, </span>
<span>                  outcomes_tbl <span class="op">=</span> <span class="va">ma_outcomes_tbl</span>, </span>
<span>                  multi_zone <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ma_AN_s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_AN.html">calc_AN</a></span><span class="op">(</span><span class="va">m2</span>, <span class="va">ma_outcomes_tbl</span>, <span class="va">ma_pop_data_long</span>,</span>
<span>                 agg_type <span class="op">=</span> <span class="st">'COUNTY20'</span>, </span>
<span>                 join_cols <span class="op">=</span> <span class="st">'TOWN20'</span>, </span>
<span>                 nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; 5    10  15  20  25  30  35  40  45  50  55  </span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span><span class="co">#&gt; 5    10  15  20  25  30  35  40  45  50  55  60  65  70  75  80  85  90  95  100     </span></span>
<span></span>
<span><span class="va">ma_AN_s1</span><span class="op">$</span><span class="va">`_`</span><span class="op">$</span><span class="va">rate_table</span></span>
<span><span class="co">#&gt;     COUNTY20 population above_MMT mean_annual_attr_rate_est</span></span>
<span><span class="co">#&gt;       &lt;char&gt;      &lt;num&gt;    &lt;lgcl&gt;                     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: MIDDLESEX    1623109      TRUE                  81.71987</span></span>
<span><span class="co">#&gt; 2: MIDDLESEX    1623109     FALSE                   0.00000</span></span>
<span><span class="co">#&gt; 3:   SUFFOLK     785443      TRUE                  97.70585</span></span>
<span><span class="co">#&gt; 4:   SUFFOLK     785443     FALSE                   0.00000</span></span>
<span><span class="co">#&gt;    mean_annual_attr_rate_lb mean_annual_attr_rate_ub</span></span>
<span><span class="co">#&gt;                       &lt;num&gt;                    &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:                 81.10122                 82.63056</span></span>
<span><span class="co">#&gt; 2:                  0.00000                  0.00000</span></span>
<span><span class="co">#&gt; 3:                 93.21673                102.38692</span></span>
<span><span class="co">#&gt; 4:                  0.00000                  0.00000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_AN_s1</span>, <span class="st">"num"</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="attributable_number_files/figure-html/checkSingle1-1.png" class="r-plt" width="768"></p>
</div>
<div class="section level3">
<h3 id="estimating-the-an---with-factors">Estimating the AN - with factors<a class="anchor" aria-label="anchor" href="#estimating-the-an---with-factors"></a>
</h3>
<p>In the case where you have factors, you can easily extend this</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ma_outcomes_tbl_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_outcome_table.html">make_outcome_table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ma_deaths</span>,<span class="va">COUNTY20</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'MIDDLESEX'</span>, <span class="st">'SUFFOLK'</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>           <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2012</span><span class="op">:</span><span class="fl">2015</span><span class="op">)</span>, </span>
<span>                                      <span class="va">outcome_columns</span>,</span>
<span>                                      collapse_to <span class="op">=</span> <span class="st">'age_grp'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ma_model_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/condPois_2stage.html">condPois_2stage</a></span><span class="op">(</span><span class="va">ma_exposure_matrix</span>, <span class="va">ma_outcomes_tbl_fct</span>, verbose <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt; age_grp : 0-17 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- stage 1</span></span>
<span><span class="co">#&gt; -- mixmeta</span></span>
<span><span class="co">#&gt; -- stage 2</span></span>
<span><span class="co">#&gt; &lt; age_grp : 18-64 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- stage 1</span></span>
<span><span class="co">#&gt; -- mixmeta</span></span>
<span><span class="co">#&gt; -- stage 2</span></span>
<span><span class="co">#&gt; &lt; age_grp : 65+ &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- stage 1</span></span>
<span><span class="co">#&gt; -- mixmeta</span></span>
<span><span class="co">#&gt; -- stage 2</span></span>
<span></span>
<span><span class="va">ma_AN_fct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_AN.html">calc_AN</a></span><span class="op">(</span><span class="va">ma_model_fct</span>, <span class="va">ma_outcomes_tbl_fct</span>,</span>
<span>                     <span class="va">ma_pop_data_long</span>,</span>
<span>                 agg_type <span class="op">=</span> <span class="st">'COUNTY20'</span>, </span>
<span>                 join_cols <span class="op">=</span> <span class="st">'TOWN20'</span>, </span>
<span>                 nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                 verbose <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt; age_grp : 0-17 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span><span class="co">#&gt; &lt; age_grp : 18-64 &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span><span class="co">#&gt; &lt; age_grp : 65+ &gt;</span></span>
<span><span class="co">#&gt; -- validation passed</span></span>
<span><span class="co">#&gt; -- estimate in each geo_unit</span></span>
<span><span class="co">#&gt; -- summarize by simulation</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ma_AN_fct</span>, <span class="st">"num"</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="attributable_number_files/figure-html/fctrun-1.png" class="r-plt" width="768"></p>
<p>These results are fictional of course but show what kind of outputs
can be made easily.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatial_plot.html">spatial_plot</a></span><span class="op">(</span><span class="va">ma_AN_fct</span>, shp <span class="op">=</span> <span class="va">ma_counties</span>, table_type <span class="op">=</span> <span class="st">"num"</span>, above_MMT <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="attributable_number_files/figure-html/multi_plot3d-1.png" class="r-plt" width="576"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
