linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_rate_ub,
ymin = mean_annual_attr_rate_lb,
x = reorder(!!sym(x_col), mean_annual_attr_rate_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_rate_est),
y = mean_annual_attr_rate_est+1,
label = round(mean_annual_attr_rate_est, 0)),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes Rate\n(# per 100,000)")
byX_df <- x$`_`$number_table
x_col <- names(byX_df)[1]
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
label = round(mean_annual_attr_num_est, 0)),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
label = scales::label_number(round(mean_annual_attr_num_est, 0))),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
label = scales::label_number(
round(mean_annual_attr_num_est, 0), big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
label = scales::number_format(
round(mean_annual_attr_num_est, 0), big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
label = scales::number(
round(mean_annual_attr_num_est, 0), big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
byX_df <- x$`_`$rate_table
x_col <- names(byX_df)[1]
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_rate_est,
x = reorder(!!sym(x_col), mean_annual_attr_rate_est)),
linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_rate_ub,
ymin = mean_annual_attr_rate_lb,
x = reorder(!!sym(x_col), mean_annual_attr_rate_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_rate_est),
y = mean_annual_attr_rate_est+1,
label = number(round(mean_annual_attr_rate_est, 1),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes Rate\n(# per 100,000)")
library(scales)
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_rate_est,
x = reorder(!!sym(x_col), mean_annual_attr_rate_est)),
linewidth = 0.4, fill = 'lightblue', col = 'black') +
geom_errorbar(aes(
ymax = mean_annual_attr_rate_ub,
ymin = mean_annual_attr_rate_lb,
x = reorder(!!sym(x_col), mean_annual_attr_rate_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_rate_est),
y = mean_annual_attr_rate_est+1,
label = number(round(mean_annual_attr_rate_est, 1),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes Rate\n(# per 100,000)")
ma_AN_fct <- calc_AN(ma_model_fct, ma_outcomes_tbl_fct,
ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 1)
x <- ma_AN_fct
class(x)
fct_names <- names(x)
fct_lab <- x[[1]]$factor_col
byX_df  <- vector("list", length(fct_names))
for(i in 1:length(byX_df)) {
byX_df[[i]] <- x[[fct_names[i]]]$`_`$rate_table
byX_df[[i]][, (fct_lab) := fct_names[i]]
}
byX_df <- do.call(rbind, byX_df)
byX_df
##
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = position_dodge2()) +
geom_errorbar(aes(
group = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
for(i in 1:length(byX_df)) {
byX_df[[i]] <- x[[fct_names[i]]]$`_`$number_table
byX_df[[i]][, (fct_lab) := fct_names[i]]
}
byX_df  <- vector("list", length(fct_names))
for(i in 1:length(byX_df)) {
byX_df[[i]] <- x[[fct_names[i]]]$`_`$number_table
byX_df[[i]][, (fct_lab) := fct_names[i]]
}
byX_df <- do.call(rbind, byX_df)
x_col <- names(byX_df)[1]
if(nrow(byX_df) > 20 * length(byX_df)) stop("too many plot elements")
##
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = position_dodge2()) +
geom_errorbar(aes(
group = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
##
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
group = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = position_dodge2()) +
geom_errorbar(aes(
group = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1, group = !!sym(fct_lab),
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
##
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
group = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = position_dodge2()) +
geom_errorbar(aes(
group = !!sym(fct_lab),
fill = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
group = !!sym(fct_lab),
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
##
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
group = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = position_dodge2()) +
geom_errorbar(aes(
color = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', width = 0.3,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
group = !!sym(fct_lab),
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
##
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
group = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = position_dodge2()) +
geom_errorbar(aes(
color = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15',
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
group = !!sym(fct_lab),
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
group = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = pd) +
geom_errorbar(aes(
group = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', position = pd,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
group = !!sym(fct_lab),
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2, position = pd) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
##
pd <- position_dodge2(width = 0.9, preserve = "single")
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_num_est,
fill = !!sym(fct_lab),
group = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
linewidth = 0.4, col = 'black', position = pd) +
geom_errorbar(aes(
group = !!sym(fct_lab),
ymax = mean_annual_attr_num_ub,
ymin = mean_annual_attr_num_lb,
x = reorder(!!sym(x_col), mean_annual_attr_num_est)),
color = 'grey15', position = pd,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_num_est),
y = mean_annual_attr_num_est+1,
group = !!sym(fct_lab),
label = number(round(mean_annual_attr_num_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2, position = pd) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes (#)")
for(i in 1:length(byX_df)) {
byX_df[[i]] <- x[[fct_names[i]]]$`_`$rate_table
byX_df[[i]][, (fct_lab) := fct_names[i]]
}
byX_df <- do.call(rbind, byX_df)
byX_df  <- vector("list", length(fct_names))
for(i in 1:length(byX_df)) {
byX_df[[i]] <- x[[fct_names[i]]]$`_`$rate_table
byX_df[[i]][, (fct_lab) := fct_names[i]]
}
byX_df <- do.call(rbind, byX_df)
x_col <- names(byX_df)[1]
if(nrow(byX_df) > 20 * length(byX_df)) stop("too many plot elements")
##
pd <- position_dodge2(width = 0.9, preserve = "single")
ggplot(byX_df) +
coord_cartesian() +
theme_classic() +
geom_col(aes(
y = mean_annual_attr_rate_est,
fill = !!sym(fct_lab),
group = !!sym(fct_lab),
x = reorder(!!sym(x_col), mean_annual_attr_rate_est)),
linewidth = 0.4, col = 'black', position = pd) +
geom_errorbar(aes(
group = !!sym(fct_lab),
ymax = mean_annual_attr_rate_ub,
ymin = mean_annual_attr_rate_lb,
x = reorder(!!sym(x_col), mean_annual_attr_rate_est)),
color = 'grey15', position = pd,
linewidth = 0.4) +
geom_label(aes(x = reorder(!!sym(x_col), mean_annual_attr_rate_est),
y = mean_annual_attr_rate_est+1,
group = !!sym(fct_lab),
label = number(round(mean_annual_attr_rate_est, 0),
big.mark = ',')),
color = 'grey15', linewidth = 0.4, fill = 'white',
size = 2, position = pd) +
theme(axis.text.x = element_text(angle= 90, hjust = 1, vjust = 0.5),
axis.title.y = element_text(angle = 0, vjust = 0.5)) +
xlab(x_col) +
ylab("Annual Heat Attr.\n Outcomes Rate (# per 100,000)")
roxygen2::roxygenise(); devtools::load_all()
plot(ma_AN_fct, "num")
devtools::build_vignettes()
devtools::build_vignettes()
devtools::build_vignettes()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_outcomes_tbl <- make_outcome_table(ma_deaths, outcome_columns)
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
plot(ma_model, "BOSTON")
ma_model$`_`$grp_plt
ma_outcomes_tbl_fct <- make_outcome_table(ma_deaths,
outcome_columns,
collapse_to = 'age_grp')
head(ma_outcomes_tbl_fct)
ma_model_fct <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl_fct, verbose = 1)
plot(ma_model_fct, "BOSTON")
plot(ma_model_fct$`0-17`, "BOSTON")
plot(ma_model_fct$`18-64`, "BOSTON")
plot(ma_model_fct, "BOSTON")
plot(ma_model_fct$`18-64`, "BOSTON")
plot(ma_model_fct$`18-64`, "BOSTON", title = 'BOSTON: 18-64')
plot(ma_model_fct, "BOSTON")
