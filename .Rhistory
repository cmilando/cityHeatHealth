"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
plot(m2)
middlesex_deaths_tbl <- make_outcome_table(
middlesex_deaths,  outcome_columns, collapse_to = 'age_grp')
# run the model
m3 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl,
multi_zone = TRUE)
# plot
plot(m3)
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
traceback()
devtools::load_all()
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
plot(ma_model, "BOSTON")
ma_model$`_`$grp_plt
forest_plot(ma_model, 25.1)
data("ma_towns")
ma_towns
head(ma_towns)
spatial_plot(ma_model, shp = ma_towns, exposure_val = 25.1)
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
ma_AN <- calc_AN(ma_model, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'TOWN20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN$`_`$rate_table
ma_AN$`_`$number_table
ma_AN <- calc_AN(ma_model, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN$`_`$rate_table
ma_AN$`_`$number_table
plot(ma_AN, table_type = 'rate', above_MMT = T)
plot(ma_AN, table_type = 'rate', above_MMT = F)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
m2
model <- m2
# starting here
x <- model$`_`
# get the blup object
n_geo_units <- length(x$out)
n_geo_units
devtools::load_all()
devtools::load_all()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
boston_exposure <- subset(ma_exposure, TOWN20 == 'BOSTON')
head(boston_exposure)
# Sept 17 2010 has NA data
boston_exposure[255:260,]
# July 13 2010 is missing
boston_exposure[190:195,]
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
head(boston_exposure_mat)
# Sept 17 2010 now has NA data
boston_exposure_mat[138:142,]
# July 13 2010 is now not missing
boston_exposure_mat[72:77,]
summary(boston_exposure_mat$tmax_C)
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
head(boston_deaths)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
library(dlnm)
library(gnm)
library(ggplot2)
library(data.table)
arg_fun = 'ns'
lag_fun = 'ns'
x_knots = quantile(boston_exposure_mat$tmax_C, probs = c(0.5, 0.9))
maxlag = 5
nk = 2
argvar <- list(fun = arg_fun, knots = x_knots)
arglag <- list(fun = lag_fun, knots = logknots(maxlag, nk = nk))
xcols <- c('tmax_C', paste0('explag',1:maxlag))
x_mat <- boston_exposure_mat[, ..xcols]
cb <- crossbasis(x_mat, lag = maxlag, argvar = argvar, arglag = arglag)
m_sub <- gnm(daily_deaths ~ cb,
data = boston_deaths_tbl,
family = quasipoisson,
eliminate = factor(strata),
subset = strata_total > 0)
summary(m_sub)
cp <- crosspred(cb, m_sub, cen = 20, by = 0.1)
cen = cp$predvar[which.min(cp$allRRfit)]
cp <- crosspred(cb, m_sub, cen = cen, by = 0.1)
plot_cp = data.frame(
x = cp$predvar,
RR = cp$allRRfit,
RRlow = cp$allRRlow,
RRhigh = cp$allRRhigh
)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
dispersion <- calc_dispersion(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
dispersion
vcov_beta <- calc_vcov(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
# update with the dipserion parameter
t1 <- vcov_beta * dispersion
# check against the original model's vcov
t2 <- vcov(m_sub)
attributes(t2) <- NULL
t2 <- matrix(t2, nrow = nrow(t1), ncol = ncol(t1))
# should be the same
all.equal(t1, t2, tolerance = 1e-8)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
# run the model
m1 <- condPois_1stage(exposure_matrix = boston_exposure_mat,
outcomes_tbl = boston_deaths_tbl)
plot(m1)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
plot(m2)
middlesex_deaths_tbl <- make_outcome_table(
middlesex_deaths,  outcome_columns, collapse_to = 'age_grp')
# run the model
m3 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl,
multi_zone = TRUE)
# plot
plot(m3)
devtools::load_all()
plot(m3)
devtools::load_all()
plot(m3)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
model <- m2
# starting here
x <- model$`_`
# get the blup object
n_geo_units <- length(x$out)
stopifnot(n_geo_units >= 1)
AN <- vector("list", n_geo_units)
n_geo_units
#
exposure_col     <- x$out[[1]]$exposure_col
exposure_col
i = 1
# things you need
this_geo   <- x$out[[i]]$geo_unit
this_geo
# things you need
this_geo   <- x$out[[i]]$geo_unit
basis_cen  <- x$out[[i]]$basis_cen
xcoef      <- x$out[[i]]$coef
xvcov      <- x$out[[i]]$vcov
outcomes   <- x$out[[i]]$outcomes
this_exp   <- x$out[[i]]$this_exp
cen        <- x$out[[i]]$cen
global_cen <- x$out[[i]]$global_cen
# and the outcome database, which should match
rr <- which(outcomes_tbl[, get(geo_unit_col)] == this_geo)
outcomes_tbl <- middlesex_deaths_tbl
head(outcomes_tbl)
# and the outcome database, which should match
rr <- which(outcomes_tbl[, get(geo_unit_col)] == this_geo)
outcomes_col     <- attributes(outcomes_tbl)$column_mapping$outcome
date_col         <- attributes(outcomes_tbl)$column_mapping$date
geo_unit_col     <- attributes(outcomes_tbl)$column_mapping$geo_unit
geo_unit_grp_col <- attributes(outcomes_tbl)$column_mapping$geo_unit_grp
geo_unit_col
# starting here
x <- model$`_`
# get the blup object
n_geo_units <- length(x$out)
stopifnot(n_geo_units >= 1)
AN <- vector("list", n_geo_units)
#
exposure_col     <- x$out[[1]]$exposure_col
# things you need
this_geo   <- x$out[[i]]$geo_unit
basis_cen  <- x$out[[i]]$basis_cen
xcoef      <- x$out[[i]]$coef
xvcov      <- x$out[[i]]$vcov
outcomes   <- x$out[[i]]$outcomes
this_exp   <- x$out[[i]]$this_exp
cen        <- x$out[[i]]$cen
global_cen <- x$out[[i]]$global_cen
# and the outcome database, which should match
rr <- which(outcomes_tbl[, get(geo_unit_col)] == this_geo)
single_outcomes_tbl <- outcomes_tbl[rr, ,drop = FALSE]
single_outcomes_tbl
single_outcomes_tbl[, get(outcomes_col)]
outcomes
if(!identical(single_outcomes_tbl[, get(outcomes_col)], outcomes)) {
print(head(single_outcomes_tbl))
print(nrow(single_outcomes_tbl))
print(head(outcomes))
print(length(outcomes))
stop('Outcomes not the same')
}
# convert to matrix
bvar_mat <- as.matrix(basis_cen)
devtools::load_all()
middlesex_deaths_tbl <- make_outcome_table(
middlesex_deaths,  outcome_columns, collapse_to = 'age_grp')
# run the model
m3 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl,
multi_zone = TRUE)
traceback()
devtools::load_all()
middlesex_deaths_tbl <- make_outcome_table(
middlesex_deaths,  outcome_columns, collapse_to = 'age_grp')
# run the model
m3 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl,
multi_zone = TRUE)
plot(m3)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
m2$`0-17`$`_`$out[[1]]$basis_cen
xmat <- m2$`0-17`$`_`$out[[1]]$basis_cen
xc <- m2$`0-17`$`_`$out[[1]]$cr_coef
xc
traceback()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
library(data.table)
data("ma_pop_data")
setDT(ma_pop_data)
ma_pop_data
ma_pop_data_long <- melt(
ma_pop_data,
id.vars = "TOWN20",
variable.name = "sex_age",
value.name = "population"
)
ma_pop_data_long$sex_age <- as.character(ma_pop_data_long$sex_age)
varnames <- strsplit(ma_pop_data_long$sex_age, "_", fixed = T)
varnames <- data.frame(do.call(rbind, varnames))
names(varnames) <- c('sex', 'age_grp')
rr <- which(varnames$sex == 'Female')
varnames$sex[rr] <- 'F'
rr <- which(varnames$sex == 'Male')
varnames$sex[rr] <- 'M'
ma_pop_data_long$sex = varnames$sex
ma_pop_data_long$age_grp = varnames$age_grp
ma_pop_data_long$sex_age <- NULL
ma_pop_data_long
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_outcomes_tbl <- make_outcome_table(ma_deaths, outcome_columns)
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
devtools::load_all()
ma_AN <- calc_AN(ma_model, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'TOWN20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN$`_`$rate_table
ma_AN$`_`$number_table
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
devtools::load_all()
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
plot(ma_AN_s1, "num", above_MMT = T)
ma_AN_s1$`_`$rate_table
ma_AN_s1$`_`$number_table
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'TOWN20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
plot(ma_AN_s1, "num", above_MMT = T)
ma_AN_s1$`_`$rate_table
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN_s1$`_`$rate_table
plot(ma_AN_s1, "num", above_MMT = T)
# run the model
m2 <- condPois_1stage(exposure_matrix = ma_exposure_matrix,
outcomes_tbl = ma_deaths, multi_zone = TRUE)
# run the model
m2 <- condPois_1stage(exposure_matrix = ma_exposure_matrix,
outcomes_tbl = ma_outcomes_tbl,
multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN_s1$`_`$rate_table
plot(ma_AN_s1, "num", above_MMT = T)
devtools::build_vignettes()
devtools::build_vignettes()
