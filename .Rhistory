x[1, get(join_col)]))
# # has to be arranged by date so the lags make sense
x <- x[order(x[, get(date_col)]), ]
# fill in any NAs using zoo::na.approx
x[, (exposure_col) := zoo::na.approx(get(exposure_col),maxgap = maxgap)]
if(any(is.na(x[, get(exposure_col)])))
stop(paste0("zoo::na.approx() was not able to remove all NAs in ",
x[1, get(join_col)]))
exposure2_l[[i]] <- x
}
# grp_level summary?
if(grp_level) {
geo_grp_col <- column_mapping$geo_unit_grp
unique_grps <- unlist(unique(data[, get(geo_grp_col)]))
n_grps <- length(unique_grps)
exposure2 <- do.call(rbind, exposure2_l)
setDT(exposure2)
# 3. Aggregate by group
# Here I'm assuming you want the mean of exposure columns; adjust as needed
exposure2 <- exposure2[, lapply(.SD, mean, na.rm = TRUE),
by = .(get(geo_grp_col), get(date_col)),
.SDcols = exposure_col]
names(exposure2)[1:2] <- c(column_mapping$geo_unit_grp, column_mapping$date)
# then in order to set up lags you need to split again
exposure2_l <- split(exposure2, f = exposure2[, get(geo_grp_col)])
length(exposure2_l)
# and update column_mapping
column_mapping$geo_unit <- column_mapping$geo_unit_grp
column_mapping$geo_unit_grp <- 'ALL'
}
for(i in 1:length(exposure2_l)) {
x <-  exposure2_l[[i]]
setDT(x)
# Now expand to get lags
for (k in seq_len(maxlag)) {
lag_name <- paste0("explag", k)
x[, (lag_name) := shift(get(exposure_col), k)]
}
exposure2_l[[i]] <- x
}
i
head(x)
for(i in 1:length(exposure2_l)) {
x <-  exposure2_l[[i]]
setDT(x)
if(nrow(x) > 0) {
# Now expand to get lags
for (k in seq_len(maxlag)) {
lag_name <- paste0("explag", k)
x[, (lag_name) := shift(get(exposure_col), k)]
}
exposure2_l[[i]] <- x
}
}
# rbind them all together
exposure2 <- do.call(rbind, exposure2_l)
# get just the warm season months
rr <- month(exposure2$date) %in% warm_season_months
warm_season_exposure <- exposure2[rr, ]
# reset the order
join_col <- column_mapping$geo_unit
date_col <- column_mapping$date
devtools::load_all()
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
ma_outcomes_table <- make_outcome_table(ma_deaths, outcome_columns)
devtools::load_all()
library(cityHeatHealth)
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
ma_outcomes_table <- make_outcome_table(ma_deaths, outcome_columns)
geo_grp_col <- outcome_columns$geo_unit_grp
unique_grps <- unlist(unique(ma_outcomes_table[, get(geo_grp_col)]))
geo_grp_col <- outcome_columns$geo_unit
unique_grps <- unlist(unique(ma_outcomes_table[, get(geo_grp_col)]))
geo_grp_col <- outcome_columns$geo_unit
unique_geos <- unlist(unique(ma_outcomes_table[, get(geo_grp_col)]))
rm(unique_grps)
cp_list <- vector("list", length(unique_geos))
seq_along(cp_list)
subset(ma_exposure_matrix, TOWN20 == 'BOSTON')
geo_grp_col <- outcome_columns$geo_unit
unique_geos <- unlist(unique(ma_outcomes_table[, get(geo_grp_col)]))
cp_list <- vector("list", length(unique_geos))
for(i in seq_along(cp_list)) {
this_geo <- unique_geos[i]
cat(this_geo, '\t')
city_exposure_mat = subset(ma_exposure_matrix, TOWN20 == this_geo)
city_deaths_tbl = subset(ma_outcomes_table, TOWN20 == this_geo)
cp_list[[i]] <- condPois(exposure_matrix = city_exposure_mat,
outcomes_tbl = city_deaths_tbl)
}
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
m1 <- cp_list[[which(unique_geos == 'CAMBRIDGE')]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
coef(m1)
vcov(m1)
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
m1 <- cp_list[[1]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
m1 <- cp_list[[6]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
m1 <- cp_list[[8]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
m1 <- cp_list[[100]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
m1 <- cp_list[[348]]
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
i = 6
this_geo <- unique_geos[i]
# cat(this_geo, '\t')
city_exposure_mat = subset(ma_exposure_matrix, TOWN20 == this_geo)
city_deaths_tbl = subset(ma_outcomes_table, TOWN20 == this_geo)
cp_list[[i]] <- condPois(exposure_matrix = city_exposure_mat,
outcomes_tbl = city_deaths_tbl)
cp_list[[i]]
coef(m1)
devtools::load_all()
devtools::build_vignettes()
devtools::load_all(); devtools::build_vignettes()
library(cityHeatHealth)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
boston_exposure <- subset(ma_exposure, TOWN20 == 'BOSTON')
head(boston_exposure)
# Sept 17 2010 has NA data
boston_exposure[255:260,]
# July 13 2010 is missing
boston_exposure[190:195,]
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
head(boston_exposure_mat)
# Sept 17 2010 now has NA data
boston_exposure_mat[138:142,]
# July 13 2010 is now not missing
boston_exposure_mat[72:77,]
summary(boston_exposure_mat$tmax_C)
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
head(boston_deaths)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
library(dlnm)
library(gnm)
library(ggplot2)
library(data.table)
arg_fun = 'ns'
lag_fun = 'ns'
x_knots = quantile(boston_exposure_mat$tmax_C, probs = c(0.5, 0.9))
maxlag = 5
nk = 2
argvar <- list(fun = arg_fun, knots = x_knots)
arglag <- list(fun = lag_fun, knots = logknots(maxlag, nk = nk))
xcols <- c('tmax_C', paste0('explag',1:maxlag))
x_mat <- boston_exposure_mat[, ..xcols]
cb <- crossbasis(x_mat, lag = maxlag, argvar = argvar, arglag = arglag)
m_sub <- gnm(daily_deaths ~ cb,
data = boston_deaths_tbl,
family = quasipoisson,
eliminate = factor(strata),
subset = keep == 1)
summary(m_sub)
cp <- crosspred(cb, m_sub, cen = 20, by = 0.1)
cen = cp$predvar[which.min(cp$allRRfit)]
cp <- crosspred(cb, m_sub, cen = cen, by = 0.1)
plot_cp = data.frame(
x = cp$predvar,
RR = cp$allRRfit,
RRlow = cp$allRRlow,
RRhigh = cp$allRRhigh
)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
dispersion <- calc_dispersion(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
dispersion
vcov_beta <- calc_vcov(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
# update with the dipserion parameter
t1 <- vcov_beta * dispersion
# check against the original model's vcov
t2 <- vcov(m_sub)
attributes(t2) <- NULL
t2 <- matrix(t2, nrow = nrow(t1), ncol = ncol(t1))
# should be the same
all.equal(t1, t2, tolerance = 1e-8)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
# run the model
m1 <- condPois(exposure_matrix = boston_exposure_mat,
outcomes_tbl = boston_deaths_tbl)
# extract the cr object
m1 <- m1$cr
m1
plot_cp = data.frame(
x = m1$predvar,
RR = m1$RRfit,
RRlow = m1$RRlow,
RRhigh = m1$RRhigh
)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
devtools::build_vignettes()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
# load exposure data
boston_exposure <- subset(ma_exposure, TOWN20 == 'BOSTON')
head(boston_exposure)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
head(boston_exposure_mat)
# load outcome data
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
head(boston_deaths)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
m1 <- condPois(exposure_matrix = boston_exposure_mat,
outcomes_tbl = boston_deaths_tbl)
plot_cp = data.frame(
x = m1$cr$predvar,
RR = m1$cr$RRfit,
RRlow = m1$cr$RRlow,
RRhigh = m1$cr$RRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
ma_outcomes_table <- make_outcome_table(ma_deaths, outcome_columns)
geo_grp_col <- outcome_columns$geo_unit
unique_geos <- unlist(unique(ma_outcomes_table[, get(geo_grp_col)]))
n_geos <- length(unique_geos)
cp_list <- vector("list", n_geos)
# the size of this changes based on what your argvar arglag are
# right because this is really based on cross-reduce, right right
coef_model <- matrix(NA, n_geos, length(c(0.5, 0.9)) + 1,
dimnames = list(unique_geos, NULL))
vcov_model <- vector("list", N_LEVELS);
names(vcov_model) <- comb_names$x
# don't need but to avoid annoying messages
GLOBAL_CEN <- 29
geo_grp_col <- outcome_columns$geo_unit
unique_geos <- unlist(unique(ma_outcomes_table[, get(geo_grp_col)]))
n_geos <- length(unique_geos)
cp_list <- vector("list", n_geos)
# the size of this changes based on what your argvar arglag are
# right because this is really based on cross-reduce, right right
coef_model <- matrix(NA, n_geos, length(c(0.5, 0.9)) + 1,
dimnames = list(unique_geos, NULL))
vcov_model <- vector("list", n_geos);
names(vcov_model) <- unique_geos
# don't need but to avoid annoying messages
GLOBAL_CEN <- 29
i = 1
this_geo <- unique_geos[i]
# cat(this_geo, '\t')
city_exposure_mat = subset(ma_exposure_matrix, TOWN20 == this_geo)
city_deaths_tbl = subset(ma_outcomes_table, TOWN20 == this_geo)
cp_list[[i]] <- condPois(city_exposure_mat, city_deaths_tbl)
coef_model[i, ] <- coef(cp_list[[i]]$cr)
vcov_model[[i]] <- vcov(cp_list[[i]]$cr)
# other things
exp_mean[[i]]   <- cp_list[[i]]$exp_mean
exp_IQR[[i]]    <- cp_list[[i]]$exp_IQR
vcov_model <- vector("list", n_geos);
exp_mean <- vector("list", n_geos);
exp_IQR <- vector("list", n_geos);
vcov_model <- vector("list", n_geos);
names(vcov_model) <- unique_geos
# don't need but to avoid annoying messages
GLOBAL_CEN <- 29
this_geo <- unique_geos[i]
# cat(this_geo, '\t')
city_exposure_mat = subset(ma_exposure_matrix, TOWN20 == this_geo)
cp_list[[i]] <- condPois(city_exposure_mat, city_deaths_tbl)
coef_model[i, ] <- coef(cp_list[[i]]$cr)
vcov_model[[i]] <- vcov(cp_list[[i]]$cr)
# other things
exp_mean[[i]]   <- cp_list[[i]]$exp_mean
exp_IQR[[i]]    <- cp_list[[i]]$exp_IQR
for(i in seq_along(cp_list)) {
this_geo <- unique_geos[i]
# cat(this_geo, '\t')
city_exposure_mat = subset(ma_exposure_matrix, TOWN20 == this_geo)
city_deaths_tbl = subset(ma_outcomes_table, TOWN20 == this_geo)
cp_list[[i]] <- condPois(city_exposure_mat, city_deaths_tbl)
coef_model[i, ] <- coef(cp_list[[i]]$cr)
vcov_model[[i]] <- vcov(cp_list[[i]]$cr)
# other things
exp_mean[[i]]   <- cp_list[[i]]$exp_mean
exp_IQR[[i]]    <- cp_list[[i]]$exp_IQR
}
for(i in seq_along(cp_list)) {
this_geo <- unique_geos[i]
cat(this_geo, '\t')
city_exposure_mat = subset(ma_exposure_matrix, TOWN20 == this_geo)
city_deaths_tbl = subset(ma_outcomes_table, TOWN20 == this_geo)
cp_list[[i]] <- condPois(city_exposure_mat, city_deaths_tbl)
coef_model[i, ] <- coef(cp_list[[i]]$cr)
vcov_model[[i]] <- vcov(cp_list[[i]]$cr)
# other things
exp_mean[[i]]   <- cp_list[[i]]$exp_mean
exp_IQR[[i]]    <- cp_list[[i]]$exp_IQR
}
m1 <- cp_list[[which(unique_geos == 'BOSTON')]]
plot_cp = data.frame(
x = m1$cr$predvar,
RR = m1$cr$RRfit,
RRlow = m1$cr$RRlow,
RRhigh = m1$cr$RRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
devtools::build_vignettes()
m1 <- condPois(exposure_matrix = boston_exposure_mat,
outcomes_tbl = boston_deaths_tbl)
devtools::build_vignettes()
roxygen2::roxygenise(); devtools::load_all(); devtools::build_vignettes()
