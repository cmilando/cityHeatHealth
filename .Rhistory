devtools::build_rmd("vignettes/bayesian_demo.Rmd")
devtools::build_rmd("vignettes/two_stage_demo.Rmd", quiet = F)
devtools::load_all()
devtools::build_rmd("vignettes/two_stage_demo.Rmd", quiet = F)
devtools::build_rmd("vignettes/two_stage_demo.Rmd", quiet = F)
devtools::build_vignettes()
devtools::load_all()
devtools::build_vignettes()
devtools::load_all()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
library(data.table)
data("ma_pop_data")
setDT(ma_pop_data)
ma_pop_data
ma_pop_data_long <- melt(
ma_pop_data,
id.vars = "TOWN20",
variable.name = "sex_age",
value.name = "population"
)
ma_pop_data_long$sex_age <- as.character(ma_pop_data_long$sex_age)
varnames <- strsplit(ma_pop_data_long$sex_age, "_", fixed = T)
varnames <- data.frame(do.call(rbind, varnames))
names(varnames) <- c('sex', 'age_grp')
rr <- which(varnames$sex == 'Female')
varnames$sex[rr] <- 'F'
rr <- which(varnames$sex == 'Male')
varnames$sex[rr] <- 'M'
ma_pop_data_long$sex = varnames$sex
ma_pop_data_long$age_grp = varnames$age_grp
ma_pop_data_long$sex_age <- NULL
ma_pop_data_long
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_outcomes_tbl <- make_outcome_table(ma_deaths, outcome_columns)
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
ma_AN <- calc_AN(ma_model, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'TOWN20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN$`_`$rate_table
ma_AN$`_`$number_table
ma_AN <- calc_AN(ma_model, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN$`_`$rate_table
ma_AN$`_`$number_table
plot(ma_AN, table_type = 'rate', above_MMT = T)
plot(ma_AN, table_type = 'rate', above_MMT = F)
data("ma_counties")
spatial_plot(ma_AN, shp = ma_counties, table_type = 'rate', above_MMT = T)
devtools::document()
devtools::document()
devtools::document()
devtools::document()
devtools::load_all()
data("ma_counties")
spatial_plot(ma_AN, shp = ma_counties, table_type = 'rate', above_MMT = T)
data("ma_counties")
spatial_plot(ma_AN, shp = ma_counties, table_type = 'rate', above_MMT = T)
devtools::load_all()
data("ma_counties")
spatial_plot(ma_AN, shp = ma_counties, table_type = 'rate', above_MMT = T)
devtools::load_all()
spatial_plot(ma_AN, shp = ma_counties, table_type = 'rate', above_MMT = T)
devtools::load_all()
spatial_plot(ma_AN, shp = ma_counties, table_type = 'rate', above_MMT = T)
ma_outcomes_tbl_fct <- make_outcome_table(ma_deaths,
outcome_columns,
collapse_to = 'age_grp')
ma_model_fct <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl_fct, verbose = 1)
ma_AN_fct <- calc_AN(ma_model_fct, ma_outcomes_tbl_fct,
ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 1)
plot(ma_AN_fct, "num", above_MMT = T)
plot(ma_AN_fct, "num", above_MMT = T)
x = ma_AN_fct
shp = ma_counties
table_type = 'rate'
above_MMT = T
stopifnot(table_type %in% c('rate', 'num'))
stopifnot(above_MMT %in% c(T, F))
geo_unit_col <- attributes(x$`_`)$column_mapping
ylab_flag <- if(above_MMT) 'Above MMT' else 'Below MMT'
byX_df <- x$`_`$number_table
stopifnot(table_type %in% c('rate', 'num'))
ylab_flag <- if(above_MMT) 'Above MMT' else 'Below MMT'
fct_names <- names(x)
fct_lab <- x[[1]]$factor_col
byX_df  <- vector("list", length(fct_names))
for(i in 1:length(byX_df)) {
byX_df[[i]] <- x[[fct_names[i]]]$`_`$number_table
byX_df[[i]][, (fct_lab) := fct_names[i]]
}
byX_df <- do.call(rbind, byX_df)
rr <- which(byX_df$above_MMT == above_MMT)
byX_df <- byX_df[rr, ]
x_col <- names(byX_df)[1]
plt_obj <- vector("list", length(names(x)))
for(i in 1:length(byX_df)) {
plt_obj[[i]] <- spatial_plot(x[[fct_names[i]]], shp,
table_type, above_MMT) +
ggtitle(paste0(fct_lab, ": ", fct_names[i]))
}
fct_names[i]
stopifnot(table_type %in% c('rate', 'num'))
ylab_flag <- if(above_MMT) 'Above MMT' else 'Below MMT'
fct_names <- names(x)
fct_lab <- x[[1]]$factor_col
names(x)
x[[names(x)]]
x[[names(x)[1]]]
plt_obj <- vector("list", length(names(x)))
for(i in 1:length(plt_obj)) {
plt_obj[[i]] <- spatial_plot(x[[names(x)[i]]], shp,
table_type, above_MMT) +
ggtitle(paste0(fct_lab, ": ", fct_names[i]))
}
wrap_plots(plt_obj, ncol = 1,guides = 'collect')
wrap_plots(plt_obj, ncol = 1,guides = 'collect')
devtools::build_vignettes()
library(cityHeatHealth)
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
devtools::document()
devtools::load_all()
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
devtools::load_all()
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
RColorBrewer::display.brewer.all()
RColorBrewer::display.brewer.all(type = 'seq')
devtools::load_all()
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
RColorBrewer::display.brewer.all(type = 'seq')
RColorBrewer::display.brewer.all(type = 'seq')[1]
names(RColorBrewer::display.brewer.all(type = 'seq'))
RColorBrewer::brewer.pal.info
row.names(subset(brewer.pal.info,
category = 'seq'))
row.names(subset(brewer.pal.info,
category == 'seq'))
row.names(subset(RColorBrewer::brewer.pal.info,
category = 'seq'))
row.names(subset(RColorBrewer::brewer.pal.info,
category == 'seq'))
tot <- row.names(subset(RColorBrewer::brewer.pal.info,
category == 'seq'))
set.seed(123)
tot <- row.names(subset(RColorBrewer::brewer.pal.info,
category == 'seq'))
sample(tot, 3, replace = F)
devtools::load_all()
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
spatial_plot(ma_AN_fct, shp = ma_counties, table_type = "num", above_MMT = T)
devtools::build_vignettes()
ma_outcomes_tbl_fct <- make_outcome_table(ma_deaths,
outcome_columns,
collapse_to = 'age_grp')
head(ma_outcomes_tbl_fct)
}
middlesex_deaths_tbl <- make_outcome_table(
middlesex_deaths,  outcome_columns, collapse_to = 'age_grp')
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
boston_exposure <- subset(ma_exposure, TOWN20 == 'BOSTON')
head(boston_exposure)
# Sept 17 2010 has NA data
boston_exposure[255:260,]
# July 13 2010 is missing
boston_exposure[190:195,]
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
head(boston_exposure_mat)
# Sept 17 2010 now has NA data
boston_exposure_mat[138:142,]
# July 13 2010 is now not missing
boston_exposure_mat[72:77,]
summary(boston_exposure_mat$tmax_C)
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
head(boston_deaths)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
library(dlnm)
library(gnm)
library(ggplot2)
library(data.table)
arg_fun = 'ns'
lag_fun = 'ns'
x_knots = quantile(boston_exposure_mat$tmax_C, probs = c(0.5, 0.9))
maxlag = 5
nk = 2
argvar <- list(fun = arg_fun, knots = x_knots)
arglag <- list(fun = lag_fun, knots = logknots(maxlag, nk = nk))
xcols <- c('tmax_C', paste0('explag',1:maxlag))
x_mat <- boston_exposure_mat[, ..xcols]
cb <- crossbasis(x_mat, lag = maxlag, argvar = argvar, arglag = arglag)
m_sub <- gnm(daily_deaths ~ cb,
data = boston_deaths_tbl,
family = quasipoisson,
eliminate = factor(strata),
subset = strata_total > 0)
summary(m_sub)
cp <- crosspred(cb, m_sub, cen = 20, by = 0.1)
cen = cp$predvar[which.min(cp$allRRfit)]
cp <- crosspred(cb, m_sub, cen = cen, by = 0.1)
plot_cp = data.frame(
x = cp$predvar,
RR = cp$allRRfit,
RRlow = cp$allRRlow,
RRhigh = cp$allRRhigh
)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
dispersion <- calc_dispersion(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
dispersion
vcov_beta <- calc_vcov(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
# update with the dipserion parameter
t1 <- vcov_beta * dispersion
# check against the original model's vcov
t2 <- vcov(m_sub)
attributes(t2) <- NULL
t2 <- matrix(t2, nrow = nrow(t1), ncol = ncol(t1))
# should be the same
all.equal(t1, t2, tolerance = 1e-8)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
# run the model
m1 <- condPois_1stage(exposure_matrix = boston_exposure_mat,
outcomes_tbl = boston_deaths_tbl)
plot(m1)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
plot(m2)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
plot(m2)
middlesex_deaths_tbl <- make_outcome_table(
middlesex_deaths,  outcome_columns, collapse_to = 'age_grp')
# run the model
m3 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl,
multi_zone = TRUE)
devtools::load_all()
# run the model
m3 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl,
multi_zone = TRUE)
devtools::load_all()
# run the model
m3 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl,
multi_zone = TRUE)
m3
devtools::load_all()
m3
x <- m3
fct_names <- names(x)
plot_cl_l <- vector("list", length(names(x)))
for(i in 1:length(names(x)) {
plot_cl_l[[i]] = data.frame(
x = x[[names(x)[i]]]$cr$predvar,
fct = names(x)[i],
RR = x[[names(x)[i]]]$cr$RRfit,
RRlow = x[[names(x)[i]]]$cr$RRlow,
RRhigh = x[[names(x)[i]]]$cr$RRhigh
)
plot_cl_l <- vector("list", length(names(x)))
for(i in 1:length(names(x))) {
plot_cl_l[[i]] = data.frame(
x = x[[names(x)[i]]]$cr$predvar,
fct = names(x)[i],
RR = x[[names(x)[i]]]$cr$RRfit,
RRlow = x[[names(x)[i]]]$cr$RRlow,
RRhigh = x[[names(x)[i]]]$cr$RRhigh
)
names(plot_cl_l[[i]])[2] <- x[[names(x)[i]]]$factor_val
}
plot_cp <- do.call(rbind, plot_cl_l)
plot_cl_l[[1]]
fct_names <- names(x)
plot_cl_l <- vector("list", length(names(x)))
for(i in 1:length(names(x))) {
plot_cl_l[[i]] = data.frame(
x = x[[names(x)[i]]]$cr$predvar,
fct = names(x)[i],
RR = x[[names(x)[i]]]$cr$RRfit,
RRlow = x[[names(x)[i]]]$cr$RRlow,
RRhigh = x[[names(x)[i]]]$cr$RRhigh
)
names(plot_cl_l[[i]])[2] <- x[[names(x)[i]]]$factor_col
}
plot_cp <- do.call(rbind, plot_cl_l)
devtools::document()
devtools::load_all()
plot(m3)
devtools::load_all()
plot(m3)
devtools::load_all()
plot(m3)
devtools::load_all()
devtools::load_all()
plot(m3)
devtools::load_all()
x <- m3
devtools::load_all()
plot(m3)
devtools::load_all()
devtools::build_vignettes()
devtools::build_rmd("vignettes/one_stage_demo.Rmd")
devtools::build_rmd("vignettes/one_stage_demo.Rmd")
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
library(data.table)
data("ma_pop_data")
setDT(ma_pop_data)
ma_pop_data
ma_pop_data_long <- melt(
ma_pop_data,
id.vars = "TOWN20",
variable.name = "sex_age",
value.name = "population"
)
ma_pop_data_long$sex_age <- as.character(ma_pop_data_long$sex_age)
varnames <- strsplit(ma_pop_data_long$sex_age, "_", fixed = T)
varnames <- data.frame(do.call(rbind, varnames))
names(varnames) <- c('sex', 'age_grp')
rr <- which(varnames$sex == 'Female')
varnames$sex[rr] <- 'F'
rr <- which(varnames$sex == 'Male')
varnames$sex[rr] <- 'M'
ma_pop_data_long$sex = varnames$sex
ma_pop_data_long$age_grp = varnames$age_grp
ma_pop_data_long$sex_age <- NULL
ma_pop_data_long
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
ma_outcomes_tbl <- make_outcome_table(ma_deaths, outcome_columns)
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
ma_AN <- calc_AN(ma_model, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'TOWN20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN$`_`$rate_table
ma_AN$`_`$number_table
ma_AN <- calc_AN(ma_model, ma_outcomes_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
ma_AN$`_`$rate_table
ma_AN$`_`$number_table
plot(ma_AN, table_type = 'rate', above_MMT = T)
plot(ma_AN, table_type = 'rate', above_MMT = F)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_exposure <- subset(ma_exposure, COUNTY20 == 'MIDDLESEX')
middlesex_exposure_mat <- make_exposure_matrix(middlesex_exposure, exposure_columns)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
middlesex_deaths   <- subset(ma_deaths, COUNTY20 == 'MIDDLESEX')
middlesex_deaths_tbl <- make_outcome_table(middlesex_deaths,  outcome_columns)
# run the model
m2 <- condPois_1stage(exposure_matrix = middlesex_exposure_mat,
outcomes_tbl = middlesex_deaths_tbl, multi_zone = TRUE)
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
devtools::load_all()
devtools::load_all()
ma_AN_s1 <- calc_AN(m2, middlesex_deaths_tbl, ma_pop_data_long,
agg_type = 'COUNTY20',
join_cols = 'TOWN20',
nsim = 100,
verbose = 2)
