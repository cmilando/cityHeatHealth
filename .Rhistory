make_exposure_matrix(boston_exposure, exposure_columns, n_lags = 8)
make_exposure_matrix(boston_exposure, exposure_columns, n_lags = 8, grp_level = T)
devtools::document()
devtools::document()
devtools::load_all()
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
devtools::load_all()
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
boston_exposure_mat
devtools::document()
stopifnot(c(1:10) %in% 1:10)
# stopifnot
stopifnot(all(warm_season_months %in% 1:12) &
length(warm_season_months) == length(unique(warm_season_months)))
warm_season_months <- c(6, 6)
# stopifnot
stopifnot(all(warm_season_months %in% 1:12) &
length(warm_season_months) == length(unique(warm_season_months)))
stopifnot(length(maxgap) == 1 & maxgap %in% 1:10)
stopifnot(length(n_lags) == 1 & n_lags %in% 1:10)
stopifnot(grp_level %in% c(T, F))
devtools::document()
devtools::load_all()
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
head(boston_exposure_mat)
devtools::load_all()
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
head(boston_exposure_mat)
# Sept 17 2010 now has NA data
boston_exposure_mat[138:142,]
# July 13 2010 is now not missing
boston_exposure_mat[72:77,]
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
outcome_columns
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
head(boston_deaths)
devtools::document()
devtools::document()
data <- boston_deaths
## create the strata
data$dow   <- wday(data$date, label = T)
data$month <- month(data$date, label = T)
data$year  <- year(data$date)
join_col <- column_mapping$geo_unit
## create the strata
data$dow   <- wday(data$date)
data$month <- month(data$date)
data$year  <- year(data$date)
join_col <- column_mapping$geo_unit
data$strata <- paste0(data[, get(join_col)], ":yr",
data$year, ":mn",
data$month, ":dow",
data$dow)
##
setDT(data)
## create the strata
data$dow   <- wday(data$date)
data$month <- month(data$date)
data$year  <- year(data$date)
join_col <- column_mapping$geo_unit
data$strata <- paste0(data[, get(join_col)], ":yr",
data$year, ":mn",
data$month, ":dow",
data$dow)
head(data)
# Extract outcome column name programmatically
outcome_col <- column_mapping$outcome
outcome_col
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
column_mapping = outcome_cols
column_mapping = outcome_columns
# Extract outcome column name programmatically
outcome_col <- column_mapping$outcome
group_col   <- "strata"
# 1. Aggregate by group and create the 'keep' flag
data_agg <- data[, .(
keep = as.integer(sum(get(outcome_col), na.rm = TRUE) > 0)
), by = group_col]
data_agg
# 2. Join back to the original data (left join)
data_comb <- data[data_agg, on = group_col]
data_comb
head(data)
data <- boston_deaths
head(data)
any(is.na(data))
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
any(is.na(boston_deaths))
data2 <- data[,.(
daily_deaths = sum(daily_deaths)
), by = .("date", "COUNTY20")]
data2 <- data[,.(
daily_deaths = sum(daily_deaths)
), by = c("date", "COUNTY20")]
data2 <- data[,.(
daily_deaths = sum(daily_deaths)
), by = .(date, COUNTY20)]
##
setDT(data)
data2 <- data[,.(
daily_deaths = sum(daily_deaths)
), by = .(date, COUNTY20)]
data2
subset(data, date == '2010-05-01')
sum(subset(data, date == '2010-05-01')$daily_deaths)
date_col = column_mapping$date
data2 <- data[,.(
daily_deaths = sum(daily_deaths)
), by = .(get(date_col), TOWN20, COUNTY20)]
date_col = column_mapping$date
geo_unit_col = column_mapping$geo_unit
geo_unit_grp_col = column_mapping$geo_unit_grp
data2 <- data[,.(
daily_deaths = sum(daily_deaths)
), by = .(get(date_col), get(geo_unit_col), get(geo_unit_grp_col))]
data2
stopifnot(join_col %in% c(geo_unit_col, geo_unit_grp_col))
# **************
## first collapse to by summing
date_col = column_mapping$date
geo_unit_col = column_mapping$geo_unit
geo_unit_grp_col = column_mapping$geo_unit_grp
outcome_col <- column_mapping$outcome
data2 <- data[,.(
xoutcome = sum(get(outcome_col))
), by = .(get(date_col),
get(geo_unit_col),
get(geo_unit_grp_col))]
data2
column_mapping$factor
which(column_mapping) == 'factor'
which(names(column_mapping) == 'factor')
column_mapping[[3:4]]
column_mapping[3:4]
factor_cols <- which(names(column_mapping) == 'factor')
factor_cols <- column_mapping[factor_cols]
factor_cols
factor_cols <- which(names(column_mapping) == 'factor')
factor_cols <- unlist(column_mapping[factor_cols])
stopifnot(collapse_to %in% factor_cols)
devtools::document()
devtools::load_all()
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
head(boston_deaths)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
data = boston_deaths
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20",
'strata_unit' = 'TOWN20'
)
column_mapping = outcome_columns
##
setDT(data)
# **************
## first collapse to by summing
date_col = column_mapping$date
geo_unit_col = column_mapping$geo_unit
geo_unit_grp_col = column_mapping$geo_unit_grp
outcome_col <- column_mapping$outcome
join_col <- column_mapping$strata_unit
stopifnot(join_col %in% c(geo_unit_col, geo_unit_grp_col))
if(is.null(collapse_to)) {
collapse_to = 'ALL'
data <- data[,.(
xoutcome = sum(get(outcome_col))
), by = .(get(date_col),
get(geo_unit_col),
get(geo_unit_grp_col))]
names(data) <- c(date_col, geo_unit_col, geo_unit_grp_col, outcome_col)
column_mapping <- list(
"date" = date_col,
"outcome" = outcome_col,
"geo_unit" = geo_unit_col,
"geo_unit_grp" = geo_unit_grp_col,
'strata_unit' = join_col
)
} else {
factor_cols <- which(names(column_mapping) == 'factor')
factor_cols <- unlist(column_mapping[factor_cols])
stopifnot(collapse_to %in% factor_cols)
data <- data[,.(
xoutcome = sum(get(outcome_col))
), by = .(get(date_col),
get(geo_unit_col),
get(geo_unit_grp_col),
get(collapse_to))]
names(data) <- c(date_col, geo_unit_col, geo_unit_grp_col, outcome_col,
collapse_to)
# update the properties here
column_mapping <- list(
"date" = date_col,
"outcome" = outcome_col,
"geo_unit" = geo_unit_col,
"geo_unit_grp" = geo_unit_grp_col,
'strata_unit' = join_col,
"factor" = collapse_to
)
}
collapse_to = NULL
if(is.null(collapse_to)) {
collapse_to = 'ALL'
data <- data[,.(
xoutcome = sum(get(outcome_col))
), by = .(get(date_col),
get(geo_unit_col),
get(geo_unit_grp_col))]
names(data) <- c(date_col, geo_unit_col, geo_unit_grp_col, outcome_col)
column_mapping <- list(
"date" = date_col,
"outcome" = outcome_col,
"geo_unit" = geo_unit_col,
"geo_unit_grp" = geo_unit_grp_col,
'strata_unit' = join_col
)
} else {
factor_cols <- which(names(column_mapping) == 'factor')
factor_cols <- unlist(column_mapping[factor_cols])
stopifnot(collapse_to %in% factor_cols)
data <- data[,.(
xoutcome = sum(get(outcome_col))
), by = .(get(date_col),
get(geo_unit_col),
get(geo_unit_grp_col),
get(collapse_to))]
names(data) <- c(date_col, geo_unit_col, geo_unit_grp_col, outcome_col,
collapse_to)
# update the properties here
column_mapping <- list(
"date" = date_col,
"outcome" = outcome_col,
"geo_unit" = geo_unit_col,
"geo_unit_grp" = geo_unit_grp_col,
'strata_unit' = join_col,
"factor" = collapse_to
)
}
data
column_mapping
# **************
## create the strata
dow <- wday(data$date)
mn  <- month(data$date)
yr  <- year(data$date)
data$strata <- paste0(data[, get(join_col)],
":yr",yr, ":mn",mn, ":dow",dow, ":", collapse_to)
# Extract outcome column name programmatically
group_col   <- "strata"
# 1. Aggregate by group and create the 'keep' flag
data_agg <- data[, .(
keep = as.integer(sum(get(outcome_col), na.rm = TRUE) > 0)
), by = group_col]
# 2. Join back to the original data (left join)
data_comb <- data[data_agg, on = group_col]
# set the class as an exposure
class(data_comb) <- c(class(data_comb), "outcoome")
# set attributes
attr(data_comb, "column_mapping") <- column_mapping
# at the end there shouldn't be any NAs, so give a warning to investigate
if(any(is.na(data_comb))) {
warning("some NAs persist, investigate")
}
#' Function to create the outcome table
#'
#' @param data
#' @param column_mapping
#' @param collapse_to
#' @import data.table
#' @returns
#' @export
#'
#' @examples
make_outcome_table <- function(data,
column_mapping,
collapse_to = NULL) {
# ********
## TODO
#' Collapse outcomes to a given factor level, or overall
#' This is a good first step and you can deal here with missing data in the record
#' like adding zeros and what not
#'
#' you also need a place to define MinN? is it here or not at all, just
#' a warning since that is what is defined later
#' *********
# column types
col_types <- c('date',
'factor',
'outcome',
'geo_unit',
'geo_unit_grp',
'strata_unit')
##
setDT(data)
# **************
## first collapse to by summing
date_col = column_mapping$date
geo_unit_col = column_mapping$geo_unit
geo_unit_grp_col = column_mapping$geo_unit_grp
outcome_col <- column_mapping$outcome
join_col <- column_mapping$strata_unit
stopifnot(join_col %in% c(geo_unit_col, geo_unit_grp_col))
if(is.null(collapse_to)) {
collapse_to = 'ALL'
data <- data[,.(
xoutcome = sum(get(outcome_col))
), by = .(get(date_col),
get(geo_unit_col),
get(geo_unit_grp_col))]
names(data) <- c(date_col, geo_unit_col, geo_unit_grp_col, outcome_col)
column_mapping <- list(
"date" = date_col,
"outcome" = outcome_col,
"geo_unit" = geo_unit_col,
"geo_unit_grp" = geo_unit_grp_col,
'strata_unit' = join_col
)
} else {
factor_cols <- which(names(column_mapping) == 'factor')
factor_cols <- unlist(column_mapping[factor_cols])
stopifnot(collapse_to %in% factor_cols)
data <- data[,.(
xoutcome = sum(get(outcome_col))
), by = .(get(date_col),
get(geo_unit_col),
get(geo_unit_grp_col),
get(collapse_to))]
names(data) <- c(date_col, geo_unit_col, geo_unit_grp_col, outcome_col,
collapse_to)
# update the properties here
column_mapping <- list(
"date" = date_col,
"outcome" = outcome_col,
"geo_unit" = geo_unit_col,
"geo_unit_grp" = geo_unit_grp_col,
'strata_unit' = join_col,
"factor" = collapse_to
)
}
# **************
## create the strata
dow <- wday(data$date)
mn  <- month(data$date)
yr  <- year(data$date)
data$strata <- paste0(data[, get(join_col)],
":yr",yr, ":mn",mn, ":dow",dow, ":", collapse_to)
# **************
# Label strata that have no cases, these will be removed later
# Extract outcome column name programmatically
group_col   <- "strata"
# 1. Aggregate by group and create the 'keep' flag
data_agg <- data[, .(
keep = as.integer(sum(get(outcome_col), na.rm = TRUE) > 0)
), by = group_col]
# 2. Join back to the original data (left join)
data_comb <- data[data_agg, on = group_col]
# **************
# prepare for output
# set the class as an exposure
class(data_comb) <- c(class(data_comb), "outcoome")
# set attributes
attr(data_comb, "column_mapping") <- column_mapping
# at the end there shouldn't be any NAs, so give a warning to investigate
if(any(is.na(data_comb))) {
warning("some NAs persist, investigate")
}
return(data_comb)
}
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20",
'strata_unit' = 'COUNTY20'
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
devtools::document()
rm(list = c("make_outcome_table"))
devtools::document()
devtools::load_all()
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns, grp_level = T)
devtools::load_all()
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns, grp_level = T)
boston_deaths_tbl
boston_deaths_tbl[order(boston_deaths_tbl$date),]
library(dlnm)
library(gnm)
library(ggplot2)
arg_fun = 'ns'
lag_fun = 'ns'
x_knots = quantile(boston_exposure_mat$tmax_C, probs = c(0.5, 0.9))
maxlag = 5
nk = 2
argvar <- list(fun = arg_fun, knots = x_knots)
arglag <- list(fun = lag_fun, knots = logknots(maxlag, nk = nk))
x_mat <- boston_exposure_mat[, c('tmax_C', paste0('explag',1:maxlag))]
cb <- crossbasis(x_mat, lag = maxlag, argvar = argvar, arglag = arglag)
head(boston_exposure_mat)
x_mat <- boston_exposure_mat[, .('tmax_C', paste0('explag',1:maxlag))]
head(x_mat)
x_mat <- boston_exposure_mat[, get('tmax_C', paste0('explag',1:maxlag))]
x_mat <- boston_exposure_mat[, ..('tmax_C', paste0('explag',1:maxlag))]
library(data.table)
x_mat <- boston_exposure_mat[, ..('tmax_C', paste0('explag',1:maxlag))]
boston_exposure_mat
xcols <- c('tmax_C', paste0('explag',1:maxlag))
x_mat <- boston_exposure_mat[, ..xcols]
cb <- crossbasis(x_mat, lag = maxlag, argvar = argvar, arglag = arglag)
head(boston_deaths_tbl)
m_sub <- gnm(daily_deaths ~ cb,
data = boston_deaths_tbl,
family = quasipoisson,
eliminate = factor(strata),
subset = keep == 1)
summary(m_sub)
cp <- crosspred(cb, m_sub, cen = 20, by = 0.1)
cen = cp$predvar[which.min(cp$allRRfit)]
cp <- crosspred(cb, m_sub, cen = cen, by = 0.1)
cp <- crosspred(cb, m_sub, cen = cen, by = 0.1)
And plot
plot_cp = data.frame(
x = cp$predvar,
RR = cp$allRRfit,
RRlow = cp$allRRlow,
RRhigh = cp$allRRhigh
)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
dispersion <- calc_dispersion(y = boston_deaths$daily_deaths,
X = cb,
stratum_vector = boston_deaths$strata,
beta = coef(m_sub))
devtools::load_all()
dispersion <- calc_dispersion(y = boston_deaths$daily_deaths,
X = cb,
stratum_vector = boston_deaths$strata,
beta = coef(m_sub))
y = boston_deaths$daily_deaths
dispersion <- calc_dispersion(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
dispersion
vcov_beta <- calc_vcov(y = boston_deaths_tbl$daily_deaths,
X = cb,
stratum_vector = boston_deaths_tbl$strata,
beta = coef(m_sub))
# update with the dipserion parameter
t1 <- vcov_beta * dispersion
# check against the original model's vcov
t2 <- vcov(m_sub)
attributes(t2) <- NULL
t2 <- matrix(t2, nrow = nrow(t1), ncol = ncol(t1))
# should be the same
all.equal(t1, t2, tolerance = 1e-8)
m_sub$x
m_sub$predictors
mean(m_sub$predictors)
boston_exposure_mat
attributes(boston_exposure_mat)
exposure_matrix <- boston_exposure_mat
exposure_col <- attributes(exposure_matrix)$column_mapping$exposure
exposure_col
devtools::load_all()
m1 <- single_run(exposure_matrix = boston_exposure_mat,
outcomes = boston_deaths_tbl)
devtools::load_all()
m1 <- single_run(exposure_matrix = boston_exposure_mat,
outcomes = boston_deaths_tbl)
plot_cp = data.frame(
x = m1$predvar,
RR = m1$allRRfit,
RRlow = m1$allRRlow,
RRhigh = m1$allRRhigh
)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
devtools::build_vignettes()
devtools::build_vignettes()
devtools::build_vignettes()
