stopifnot(global_cen >= min(this_exp) & global_cen <= max(this_exp))
basis_mmt <- do.call("onebasis", modifyList(this_argvar, list(x=global_cen)))
} else {
cen = cp_list[[i]]$cr$cen
basis_mmt <- do.call("onebasis", modifyList(this_argvar, list(x=cen)))
}
# *********
# (3) Center and scale
basis_cen <- scale(basis_x, center = basis_mmt, scale = FALSE)
# Apply to a grid
grid <- seq(from = min(this_exp), to = max(this_exp), by = 0.01)
# get the cross-pred object
cp1 <- dlnm::crosspred(basis_cen,
cen = cen,
coef = blup_geo[[i]]$blup,
vcov = blup_geo[[i]]$vcov,
model.link = "log",
at = grid)
}
exposure_col <- attributes(exposure_matrix)$column_mapping$exposure
# loop through geos
for(i in seq_along(cp_list)) {
#
this_geo <- unique_geos[i, get(outcome_columns$geo_unit)]
# get x
rr <- exposure_matrix[, get(exp_geo_unit_col)] == this_geo
single_exposure_matrix = exposure_matrix[rr, ,drop = FALSE]
this_exp <- single_exposure_matrix[, get(exposure_col)]
# get argvar
this_argvar <- argvar_list[[i]]
# (1) get onebasis
basis_x <- do.call("onebasis", modifyList(this_argvar, list(x=this_exp)))
# *********
# (2) Center basis
# either MMT or GLOBAL CEN
if(!is.null(global_cen)) {
cen = global_cen
stopifnot(global_cen >= min(this_exp) & global_cen <= max(this_exp))
basis_mmt <- do.call("onebasis", modifyList(this_argvar, list(x=global_cen)))
} else {
cen = cp_list[[i]]$cr$cen
basis_mmt <- do.call("onebasis", modifyList(this_argvar, list(x=cen)))
}
# *********
# (3) Center and scale
basis_cen <- scale(basis_x, center = basis_mmt, scale = FALSE)
# Apply to a grid
grid <- seq(from = min(this_exp), to = max(this_exp), by = 0.01)
# get the cross-pred object
cp1 <- dlnm::crosspred(basis_cen,
cen = cen,
coef = blup_geo[[i]]$blup,
vcov = blup_geo[[i]]$vcov,
model.link = "log",
at = grid)
}
cp_out   <- vector("list", n_geos);
# loop through geos
for(i in seq_along(cp_list)) {
#
this_geo <- unique_geos[i, get(outcome_columns$geo_unit)]
# get x
rr <- exposure_matrix[, get(exp_geo_unit_col)] == this_geo
single_exposure_matrix = exposure_matrix[rr, ,drop = FALSE]
this_exp <- single_exposure_matrix[, get(exposure_col)]
# get argvar
this_argvar <- argvar_list[[i]]
# (1) get onebasis
basis_x <- do.call("onebasis", modifyList(this_argvar, list(x=this_exp)))
# *********
# (2) Center basis
# either MMT or GLOBAL CEN
if(!is.null(global_cen)) {
cen = global_cen
stopifnot(global_cen >= min(this_exp) & global_cen <= max(this_exp))
basis_mmt <- do.call("onebasis", modifyList(this_argvar, list(x=global_cen)))
} else {
cen = cp_list[[i]]$cr$cen
basis_mmt <- do.call("onebasis", modifyList(this_argvar, list(x=cen)))
}
# *********
# (3) Center and scale
basis_cen <- scale(basis_x, center = basis_mmt, scale = FALSE)
# Apply to a grid
grid <- seq(from = min(this_exp), to = max(this_exp), by = 0.01)
# get the cross-pred object
cp_out[[i]] <- crosspred(basis_cen,
cen = cen,
coef = blup_geo[[i]]$blup,
vcov = blup_geo[[i]]$vcov,
model.link = "log",
at = grid)
}
roxygen2::roxygenise(); devtools::load_all()
exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
outcomes_tbl <- make_outcome_table(ma_deaths, outcome_columns)
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl)
traceback()
splines::ns(x = 6.2, knots = c(`50%` = 26.4729, `90%` = 31.43134))
cp_list[[i]]$cr$predvar
x_boundary <- range(this_exp)
x_boundary
range(cp_list[[i]]$cr$predvar)
x_boundary <- c(floor(min(this_exp)), ceiling(max(this_exp)))
x_b <- c(floor(min(this_exp)), ceiling(max(this_exp)))
x_b
# (1) get onebasis
basis_x <- do.call("onebasis", modifyList(this_argvar,
list(x=this_exp,
Boundary.knots = x_b)))
# *********
# (2) Center basis
# either MMT or GLOBAL CEN
if(!is.null(global_cen)) {
cen = global_cen
stopifnot(global_cen >= x_b[1] & global_cen <= x_b[2])
basis_mmt <- do.call("onebasis", modifyList(this_argvar,
list(x=global_cen,
Boundary.knots = x_b)))
} else {
cen = cp_list[[i]]$cr$cen
basis_mmt <- do.call("onebasis",
modifyList(this_argvar,
list(x=cen, Boundary.knots = x_b))
}
# (1) get onebasis
basis_x <- do.call("onebasis", modifyList(this_argvar,
list(x=this_exp,
Boundary.knots = x_b)))
# *********
# (2) Center basis
# either MMT or GLOBAL CEN
if(!is.null(global_cen)) {
cen = global_cen
stopifnot(global_cen >= x_b[1] & global_cen <= x_b[2])
basis_mmt <- do.call("onebasis", modifyList(this_argvar,
list(x=global_cen,
Boundary.knots = x_b)))
} else {
cen = cp_list[[i]]$cr$cen
basis_mmt <- do.call("onebasis",
modifyList(this_argvar,
list(x=cen, Boundary.knots = x_b)))
}
# (3) Center and scale
basis_cen <- scale(basis_x, center = basis_mmt, scale = FALSE)
# loop through geos
for(i in seq_along(cp_list)) {
#
this_geo <- unique_geos[i, get(outcome_columns$geo_unit)]
# get x
rr <- exposure_matrix[, get(exp_geo_unit_col)] == this_geo
single_exposure_matrix = exposure_matrix[rr, ,drop = FALSE]
this_exp <- single_exposure_matrix[, get(exposure_col)]
x_b <- c(floor(min(this_exp)), ceiling(max(this_exp)))
# get argvar
this_argvar <- argvar_list[[i]]
# (1) get onebasis
basis_x <- do.call("onebasis", modifyList(this_argvar,
list(x=this_exp,
Boundary.knots = x_b)))
# *********
# (2) Center basis
# either MMT or GLOBAL CEN
if(!is.null(global_cen)) {
cen = global_cen
stopifnot(global_cen >= x_b[1] & global_cen <= x_b[2])
basis_mmt <- do.call("onebasis", modifyList(this_argvar,
list(x=global_cen,
Boundary.knots = x_b)))
} else {
cen = cp_list[[i]]$cr$cen
basis_mmt <- do.call("onebasis",
modifyList(this_argvar,
list(x=cen, Boundary.knots = x_b)))
}
# *********
# (3) Center and scale
basis_cen <- scale(basis_x, center = basis_mmt, scale = FALSE)
# Apply to a grid
grid <- seq(from =  x_b[1], to = x_b[2], by = 0.1)
# get the cross-pred object
cp_out[[i]] <- crosspred(basis_cen,
cen = cen,
coef = blup_geo[[i]]$blup,
vcov = blup_geo[[i]]$vcov,
model.link = "log",
at = grid)
}
# create the random effect formula
rf = as.formula(paste0("~ 1 | ", outcome_columns$geo_unit_grp, "/",
outcome_columns$geo_unit))
rf
# create the random effect formula
rf = as.formula(paste0("~ 1 | ", outcome_columns$geo_unit_grp, " / ",
outcome_columns$geo_unit))
rf
# create the random effect formula
rf = as.formula(paste0("~ 1 | ", outcome_columns$geo_unit_grp, " / ",
outcome_columns$geo_unit))
# see function description for references for this
meta_fit <- mixmeta(coef_matrix ~ exp_mean + exp_IQR,
random = rf,
S = vcov_list,
data = unique_geos,
control = list(showiter=verbose),
na.action = 'na.exclude')
# get BLUP
blup_geo <- blup(meta_fit, vcov = T)
names(blup_geo) = unique_geos
devtools::load_all()
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
library(cityHeatHealth)
boston_exposure <- subset(ma_exposure, TOWN20 == 'BOSTON')
head(boston_exposure)
# create exposure matrix
exposure_columns <- list(
"date" = "date",
"exposure" = "tmax_C",
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_exposure_mat <- make_exposure_matrix(boston_exposure, exposure_columns)
head(boston_exposure_mat)
# load outcome data
boston_deaths   <- subset(ma_deaths, TOWN20 == 'BOSTON')
head(boston_deaths)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
m1 <- condPois_single(exposure_matrix = boston_exposure_mat,
outcomes_tbl = boston_deaths_tbl)
plot_cp = data.frame(
x = m1$cr$predvar,
RR = m1$cr$RRfit,
RRlow = m1$cr$RRlow,
RRhigh = m1$cr$RRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
outcomes_tbl <- make_outcome_table(ma_deaths, outcome_columns)
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl)
ma_model
devtools::load_all()
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl, verbose = T)
1 == T
2 == T
devtools::load_all()
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl, verbose = 1)
devtools::load_all()
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl, verbose = 1)
ma_model$blup_cp
names(ma_model$blup_cp)
ii = 8
plot_cp = data.frame(
x = ma_model$blup_cp[[ii]]$predvar,
RR = ma_model$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ma_model$meta_fit$model$TOWN20
ii = 36
plot_cp = data.frame(
x = ma_model$blup_cp[[ii]]$predvar,
RR = ma_model$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ma_model$meta_fit$model$TOWN20[[ii]]
# load outcome data
boston_deaths   <- subset(ma_deaths, TOWN20 == 'CAMBRIDGE')
head(boston_deaths)
# create outcome table
outcome_columns <- list(
"date" = "date",
"outcome" = "daily_deaths",
"factor" = 'age_grp',
"factor" = 'sex',
"geo_unit" = "TOWN20",
"geo_unit_grp" = "COUNTY20"
)
boston_deaths_tbl <- make_outcome_table(boston_deaths,  outcome_columns)
head(boston_deaths_tbl)
m1 <- condPois_single(exposure_matrix = boston_exposure_mat,
outcomes_tbl = boston_deaths_tbl)
devtools::load_all()
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl, verbose = 1)
attributes(ma_model$blup_cp[[ii]], "geo_unit")
attr(ma_model$blup_cp[[ii]], "geo_unit")
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
plot_cp = data.frame(
tt = attr(ma_model$blup_cp[[ii]], "geo_unit")
x = ma_model$blup_cp[[ii]]$predvar,
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
tt = attr(ma_model$blup_cp[[ii]], "geo_unit")
plot_cp = data.frame(
x = ma_model$blup_cp[[ii]]$predvar,
RR = ma_model$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ii = 100
ma_model$meta_fit$model$TOWN20[[ii]]
attr(ma_model$blup_cp[[ii]], "geo_unit")
tt = attr(ma_model$blup_cp[[ii]], "geo_unit")
plot_cp = data.frame(
x = ma_model$blup_cp[[ii]]$predvar,
RR = ma_model$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ii = 150
ma_model$meta_fit$model$TOWN20[[ii]]
attr(ma_model$blup_cp[[ii]], "geo_unit")
tt = attr(ma_model$blup_cp[[ii]], "geo_unit")
plot_cp = data.frame(
x = ma_model$blup_cp[[ii]]$predvar,
RR = ma_model$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl, verbose = 1,
global_cen = 30)
ii = 150
ma_model$meta_fit$model$TOWN20[[ii]]
attr(ma_model$blup_cp[[ii]], "geo_unit")
tt = attr(ma_model$blup_cp[[ii]], "geo_unit")
plot_cp = data.frame(
x = ma_model$blup_cp[[ii]]$predvar,
RR = ma_model$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl, verbose = 1)
roxygen2::roxygenise(); devtools::clean_vignettes()
devtools::load_all()
ma_model <- condPois_2stage(exposure_matrix, outcomes_tbl, verbose = 1)
ii = 150
ma_model$`_`$$meta_fit$model$TOWN20[[ii]]
ii = 150
ma_model$`_`$meta_fit$model$TOWN20[[ii]]
attr(ma_model$`_`$blup_cp[[ii]], "geo_unit")
tt = attr(ma_model$`_`$blup_cp[[ii]], "geo_unit")
plot_cp = data.frame(
x = ma_model$`_`$blup_cp[[ii]]$predvar,
RR = ma_model$`_`$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$`_`$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$`_`$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ii = 36
ma_model$`_`$meta_fit$model$TOWN20[[ii]]
attr(ma_model$`_`$blup_cp[[ii]], "geo_unit")
tt = attr(ma_model$`_`$blup_cp[[ii]], "geo_unit")
plot_cp = data.frame(
x = ma_model$`_`$blup_cp[[ii]]$predvar,
RR = ma_model$`_`$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$`_`$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$`_`$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
ma_outcomes_tbl <- make_outcome_table(ma_deaths,
outcome_columns,
collapse_to = 'age_grp')
ma_outcomes_tbl
factor_col <- attributes(outcomes_tbl)$column_mapping$factor
factor_col
outcomes_tbl
outcomes_tbl <- ma_outcomes_tbl
ma_outcomes_tbl
attributes(outcomes_tbl)$column_mapping$factor
factor_col <- attributes(outcomes_tbl)$column_mapping$factor
unique_fcts <- unlist(unique(outcomes_tbl[, get(factor_col)]))
unique_fcts
fct_i
fct_i = 1
cat("<", unique_fcts[fct_i], ">\n" )
cat("<",factor_col,": ", unique_fcts[fct_i], ">\n" )
cat("<",factor_col,":", unique_fcts[fct_i], ">\n")
devtools::load_all()
ma_outcomes_tbl <- make_outcome_table(ma_deaths,
outcome_columns,
collapse_to = 'age_grp')
head(ma_outcomes_tbl)
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
ma_exposure_matrix <- make_exposure_matrix(ma_exposure, exposure_columns)
ma_outcomes_tbl
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
devtools::load_all()
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
devtools::load_all()
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
subset_outcomes_tbl
rr <- which(outcomes_tbl[, get(factor_col)] == unique_fcts[fct_i])
subset_outcomes_tbl <- outcomes_tbl[rr, , drop = FALSE]
subset_outcomes_tbl
condPois_2stage(exposure_matrix,
subset_outcomes_tbl,
global_cen = global_cen,
argvar = argvar,
arglag = arglag,
maxlag = maxlag,
min_n = min_n,
strata_min = strata_min,
verbose = verbose)
roxygen2::roxygenise()
attributes(subset_outcomes_tbl)$column_mapping$factor <- NULL
attributes(subset_outcomes_tbl)$column_mapping
devtools::load_all()
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
ma_model$`0-17`$meta_fit$model$TOWN20[[ii]]
a_model$`0-17`$meta_fit$model
devtools::load_all()
ma_model <- condPois_2stage(ma_exposure_matrix, ma_outcomes_tbl, verbose = 1)
ii = 36
tt = attr(ma_model$`0-17`$blup_cp[[ii]], "geo_unit")
tt
ii = 36
tt = attr(ma_model$`0-17`$blup_cp[[ii]], "geo_unit")
plot_cp = data.frame(
x = ma_model$`0-17`$blup_cp[[ii]]$predvar,
RR = ma_model$`0-17`$blup_cp[[ii]]$allRRfit,
RRlow = ma_model$`0-17`$blup_cp[[ii]]$allRRlow,
RRhigh = ma_model$`0-17`$blup_cp[[ii]]$allRRhigh
)
library(ggplot2)
ggplot(plot_cp, aes(x = x, y = RR, ymin = RRlow, ymax = RRhigh)) +
geom_hline(yintercept = 1, linetype = '11') +
theme_classic() +
ggtitle(tt) +
geom_ribbon(fill = 'grey75', alpha = 0.2) +
geom_line() + xlab("Tmax (degC)")
roxygen2::roxygenise(); devtools::load_all(); devtools::build_vignettes()
